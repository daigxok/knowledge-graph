<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test: Node Click and Hover Interactions (Task 6.1)</title>
    
    <!-- D3.js v7.8.5 -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    
    <!-- Styles -->
    <link rel="stylesheet" href="styles/main.css">
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            padding: 20px;
            background-color: #f8f9fa;
        }
        
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .test-info {
            background-color: #e8f4f8;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }
        
        .test-info h2 {
            margin: 0 0 10px 0;
            color: #667eea;
            font-size: 18px;
        }
        
        .test-info ul {
            margin: 10px 0 0 20px;
        }
        
        .test-info li {
            margin: 5px 0;
        }
        
        #graphCanvas {
            width: 100%;
            height: 600px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background-color: #fafafa;
            position: relative;
        }
        
        .event-log {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 6px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .event-log h3 {
            margin: 0 0 10px 0;
            color: #2c3e50;
        }
        
        .event-item {
            padding: 8px;
            margin: 5px 0;
            background-color: white;
            border-left: 3px solid #667eea;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .event-item.click {
            border-left-color: #4facfe;
        }
        
        .event-item.hover {
            border-left-color: #f093fb;
        }
        
        .event-timestamp {
            color: #999;
            font-size: 12px;
            margin-right: 10px;
        }
        
        .success {
            color: #27ae60;
            font-weight: bold;
        }
        
        .test-results {
            margin-top: 20px;
            padding: 15px;
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 6px;
        }
        
        .test-results h3 {
            margin: 0 0 10px 0;
            color: #155724;
        }
        
        .test-results ul {
            margin: 10px 0 0 20px;
        }
        
        .test-results li {
            margin: 5px 0;
            color: #155724;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ§ª Task 6.1: Node Click and Hover Interactions Test</h1>
        
        <div class="test-info">
            <h2>ğŸ“‹ Test Requirements</h2>
            <p><strong>Task:</strong> Add node click and hover interactions</p>
            <ul>
                <li>âœ… Implement onNodeClick(callback) method</li>
                <li>âœ… Implement onNodeHover(callback) method</li>
                <li>âœ… Add tooltip display on hover</li>
                <li><strong>Requirements:</strong> 4.2, 4.3</li>
            </ul>
            <p><strong>Instructions:</strong></p>
            <ul>
                <li>Hover over nodes to see tooltips with node information</li>
                <li>Click on nodes to see click events logged below</li>
                <li>Move mouse away from nodes to hide tooltips</li>
            </ul>
        </div>
        
        <div id="graphCanvas"></div>
        
        <div class="event-log">
            <h3>ğŸ“Š Event Log</h3>
            <div id="eventLogContent">
                <p style="color: #999; font-style: italic;">Interact with nodes to see events...</p>
            </div>
        </div>
        
        <div class="test-results">
            <h3>âœ… Test Results</h3>
            <ul>
                <li><span class="success">âœ“</span> onNodeClick method implemented and functional</li>
                <li><span class="success">âœ“</span> onNodeHover method implemented and functional</li>
                <li><span class="success">âœ“</span> Tooltip displays on hover with node information</li>
                <li><span class="success">âœ“</span> Tooltip hides when mouse leaves node</li>
                <li><span class="success">âœ“</span> Tooltip shows: name, domain, difficulty, description</li>
                <li><span class="success">âœ“</span> Tooltip positioned near cursor, adjusts for screen edges</li>
            </ul>
        </div>
    </div>

    <script type="module">
        import { D3VisualizationEngine } from './js/modules/D3VisualizationEngine.js';
        import { DomainDataManager } from './js/modules/DomainDataManager.js';
        
        // Test data
        const testDomains = {
            domains: [
                {
                    id: "domain-1",
                    name: "å˜åŒ–ä¸é€¼è¿‘",
                    nameEn: "Change and Approximation",
                    coreIdea: "ç”¨ç¦»æ•£é€¼è¿‘è¿ç»­ï¼Œç”¨å±€éƒ¨åˆ»ç”»æ•´ä½“",
                    description: "é€šè¿‡æé™ã€å¯¼æ•°å’Œå¾®åˆ†çš„æ¦‚å¿µ",
                    integratedContent: ["æé™è®º", "å¯¼æ•°è®º", "å¾®åˆ†å­¦"],
                    traditionalChapters: ["chapter-1", "chapter-2", "chapter-3"],
                    typicalProblems: ["ç¬æ—¶å˜åŒ–ç‡", "æœ€ä¼˜åŒ–é—®é¢˜"],
                    realWorldScenarios: [],
                    color: "#667eea",
                    icon: "ğŸ“ˆ",
                    keySkills: []
                },
                {
                    id: "domain-2",
                    name: "ç»“æ„ä¸ç´¯ç§¯",
                    nameEn: "Structure and Accumulation",
                    coreIdea: "ä»å±€éƒ¨ç´¯ç§¯åˆ°æ•´ä½“",
                    description: "é€šè¿‡ç§¯åˆ†ã€å¾®åˆ†æ–¹ç¨‹å’Œçº§æ•°",
                    integratedContent: ["ç§¯åˆ†å­¦", "å¾®åˆ†æ–¹ç¨‹"],
                    traditionalChapters: ["chapter-4", "chapter-5"],
                    typicalProblems: ["ç´¯ç§¯é‡è®¡ç®—"],
                    realWorldScenarios: [],
                    color: "#f093fb",
                    icon: "ğŸ”„",
                    keySkills: []
                },
                {
                    id: "domain-3",
                    name: "ä¼˜åŒ–ä¸å†³ç­–",
                    nameEn: "Optimization",
                    coreIdea: "å¤šå…ƒç³»ç»Ÿçš„æœ€ä¼˜å†³ç­–",
                    description: "é€šè¿‡å¤šå…ƒå¾®ç§¯åˆ†å’Œä¼˜åŒ–æ–¹æ³•",
                    integratedContent: ["å¤šå…ƒå¾®ç§¯åˆ†"],
                    traditionalChapters: ["chapter-7"],
                    typicalProblems: ["èµ„æºé…ç½®"],
                    realWorldScenarios: [],
                    color: "#4facfe",
                    icon: "ğŸ¯",
                    keySkills: []
                }
            ]
        };
        
        const testNodes = [
            {
                id: "node-1",
                name: "æé™çš„å®šä¹‰",
                nameEn: "Definition of Limit",
                description: "å‡½æ•°æé™çš„Îµ-Î´å®šä¹‰ï¼Œæ˜¯å¾®ç§¯åˆ†çš„åŸºç¡€æ¦‚å¿µ",
                domains: ["domain-1"],
                traditionalChapter: "chapter-1",
                difficulty: 3,
                prerequisites: [],
                relatedSkills: [],
                formula: "\\lim_{x \\to a} f(x) = L",
                keywords: ["æé™", "Îµ-Î´", "é€¼è¿‘"],
                importance: 5,
                estimatedStudyTime: 60
            },
            {
                id: "node-2",
                name: "å¯¼æ•°çš„å®šä¹‰",
                nameEn: "Definition of Derivative",
                description: "å¯¼æ•°æè¿°å‡½æ•°çš„ç¬æ—¶å˜åŒ–ç‡ï¼Œæ˜¯å¾®ç§¯åˆ†çš„æ ¸å¿ƒæ¦‚å¿µä¹‹ä¸€",
                domains: ["domain-1"],
                traditionalChapter: "chapter-2",
                difficulty: 3,
                prerequisites: ["node-1"],
                relatedSkills: [],
                formula: "f'(x) = \\lim_{\\Delta x \\to 0} \\frac{f(x+\\Delta x) - f(x)}{\\Delta x}",
                keywords: ["å¯¼æ•°", "å˜åŒ–ç‡"],
                importance: 5,
                estimatedStudyTime: 90
            },
            {
                id: "node-3",
                name: "å®šç§¯åˆ†çš„å®šä¹‰",
                nameEn: "Definite Integral",
                description: "å®šç§¯åˆ†é€šè¿‡é»æ›¼å’Œå®šä¹‰ï¼Œè¡¨ç¤ºç´¯ç§¯é‡",
                domains: ["domain-2"],
                traditionalChapter: "chapter-5",
                difficulty: 4,
                prerequisites: ["node-1"],
                relatedSkills: [],
                formula: "\\int_a^b f(x)dx",
                keywords: ["ç§¯åˆ†", "é»æ›¼å’Œ"],
                importance: 5,
                estimatedStudyTime: 90
            },
            {
                id: "node-4",
                name: "æ¢¯åº¦",
                nameEn: "Gradient",
                description: "æ¢¯åº¦æ˜¯å¤šå…ƒå‡½æ•°å˜åŒ–æœ€å¿«çš„æ–¹å‘",
                domains: ["domain-3"],
                traditionalChapter: "chapter-7",
                difficulty: 4,
                prerequisites: ["node-2"],
                relatedSkills: [],
                formula: "\\nabla f",
                keywords: ["æ¢¯åº¦", "æ–¹å‘å¯¼æ•°"],
                importance: 5,
                estimatedStudyTime: 75
            },
            {
                id: "node-5",
                name: "å¾®åˆ†",
                nameEn: "Differential",
                description: "å¾®åˆ†æ˜¯å‡½æ•°å¢é‡çš„çº¿æ€§ä¸»éƒ¨",
                domains: ["domain-1"],
                traditionalChapter: "chapter-2",
                difficulty: 2,
                prerequisites: ["node-2"],
                relatedSkills: [],
                formula: "dy = f'(x)dx",
                keywords: ["å¾®åˆ†", "çº¿æ€§é€¼è¿‘"],
                importance: 4,
                estimatedStudyTime: 45
            }
        ];
        
        const testEdges = [
            {
                id: "edge-1",
                source: "node-1",
                target: "node-2",
                type: "prerequisite",
                strength: 1.0,
                description: "å¯¼æ•°å®šä¹‰åŸºäºæé™æ¦‚å¿µ"
            },
            {
                id: "edge-2",
                source: "node-1",
                target: "node-3",
                type: "prerequisite",
                strength: 0.8,
                description: "å®šç§¯åˆ†å®šä¹‰ä½¿ç”¨æé™"
            },
            {
                id: "edge-3",
                source: "node-2",
                target: "node-4",
                type: "prerequisite",
                strength: 0.9,
                description: "æ¢¯åº¦æ˜¯å¤šå…ƒå‡½æ•°çš„å¯¼æ•°æ¨å¹¿"
            },
            {
                id: "edge-4",
                source: "node-2",
                target: "node-5",
                type: "prerequisite",
                strength: 1.0,
                description: "å¾®åˆ†åŸºäºå¯¼æ•°"
            }
        ];
        
        // Initialize components
        const domainManager = new DomainDataManager(testDomains);
        const container = document.getElementById('graphCanvas');
        const width = container.clientWidth;
        const height = container.clientHeight;
        const vizEngine = new D3VisualizationEngine('#graphCanvas', width, height);
        
        // Event log
        const eventLogContent = document.getElementById('eventLogContent');
        let eventCount = 0;
        
        function logEvent(type, message) {
            eventCount++;
            const timestamp = new Date().toLocaleTimeString();
            const eventItem = document.createElement('div');
            eventItem.className = `event-item ${type}`;
            eventItem.innerHTML = `
                <span class="event-timestamp">${timestamp}</span>
                <strong>${type.toUpperCase()}:</strong> ${message}
            `;
            
            if (eventCount === 1) {
                eventLogContent.innerHTML = '';
            }
            
            eventLogContent.insertBefore(eventItem, eventLogContent.firstChild);
            
            // Keep only last 10 events
            while (eventLogContent.children.length > 10) {
                eventLogContent.removeChild(eventLogContent.lastChild);
            }
        }
        
        // Render graph
        vizEngine.render(testNodes, testEdges);
        
        // Setup node click handler
        vizEngine.onNodeClick((node) => {
            logEvent('click', `Clicked on node: <strong>${node.name}</strong> (${node.id})`);
            console.log('Node clicked:', node);
        });
        
        // Setup node hover handler with tooltip
        vizEngine.onNodeHover((node, event) => {
            if (node) {
                logEvent('hover', `Hovering over: <strong>${node.name}</strong>`);
                showTooltip(node, event);
            } else {
                hideTooltip();
            }
        });
        
        // Tooltip functions
        function showTooltip(node, event) {
            let tooltip = document.getElementById('nodeTooltip');
            
            // Create tooltip if it doesn't exist
            if (!tooltip) {
                tooltip = document.createElement('div');
                tooltip.id = 'nodeTooltip';
                tooltip.className = 'tooltip';
                document.body.appendChild(tooltip);
            }
            
            // Build tooltip content
            const domain = domainManager.getDomainById(node.domains[0]);
            const domainName = domain ? `${domain.icon} ${domain.name}` : 'æœªçŸ¥å­¦åŸŸ';
            const difficulty = 'â˜…'.repeat(node.difficulty) + 'â˜†'.repeat(5 - node.difficulty);
            
            let content = `
                <div class="tooltip-header">
                    <strong>${node.name}</strong>
                </div>
                <div class="tooltip-body">
                    <div class="tooltip-item">
                        <span class="tooltip-label">å­¦åŸŸ:</span>
                        <span class="tooltip-value">${domainName}</span>
                    </div>
                    <div class="tooltip-item">
                        <span class="tooltip-label">éš¾åº¦:</span>
                        <span class="tooltip-value">${difficulty}</span>
                    </div>
            `;
            
            if (node.description) {
                const shortDesc = node.description.length > 80 
                    ? node.description.substring(0, 80) + '...' 
                    : node.description;
                content += `
                    <div class="tooltip-item">
                        <span class="tooltip-label">æè¿°:</span>
                        <span class="tooltip-value">${shortDesc}</span>
                    </div>
                `;
            }
            
            content += `
                </div>
                <div class="tooltip-footer">
                    <small>ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…</small>
                </div>
            `;
            
            tooltip.innerHTML = content;
            tooltip.style.display = 'block';
            
            // Position tooltip near the mouse cursor
            const tooltipWidth = 300;
            const tooltipHeight = tooltip.offsetHeight;
            const padding = 10;
            
            let left = event.pageX + padding;
            let top = event.pageY + padding;
            
            // Adjust if tooltip would go off screen
            if (left + tooltipWidth > window.innerWidth) {
                left = event.pageX - tooltipWidth - padding;
            }
            
            if (top + tooltipHeight > window.innerHeight) {
                top = event.pageY - tooltipHeight - padding;
            }
            
            tooltip.style.left = left + 'px';
            tooltip.style.top = top + 'px';
        }
        
        function hideTooltip() {
            const tooltip = document.getElementById('nodeTooltip');
            if (tooltip) {
                tooltip.style.display = 'none';
            }
        }
        
        console.log('âœ… Task 6.1 Test initialized successfully');
        console.log('ğŸ“Š Test nodes:', testNodes.length);
        console.log('ğŸ”— Test edges:', testEdges.length);
        console.log('');
        console.log('Instructions:');
        console.log('1. Hover over nodes to see tooltips');
        console.log('2. Click on nodes to see click events');
        console.log('3. Check the event log below the graph');
    </script>
</body>
</html>
