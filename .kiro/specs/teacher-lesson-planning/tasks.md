# 实施计划：教师备课功能

## 概述

本实施计划将教师备课功能分解为可执行的编码任务。项目将在现有知识图谱系统基础上，扩展认证模块支持角色管理，新增节点编辑器和教案生成器，实现教师对知识图谱的创建、编辑和教学设计功能。

实施策略采用增量开发方式：首先扩展认证和权限系统，然后实现节点编辑功能，最后实现教案生成和导出功能。每个主要阶段后设置检查点，确保质量和进度可控。

## 任务列表

### 阶段 1: 认证和权限系统扩展

- [ ] 1. 扩展Auth模块支持角色管理
  - [ ] 1.1 修改Auth.js添加角色字段
    - 在用户数据结构中添加role字段（'teacher' | 'student'）
    - 修改register方法支持角色参数
    - 修改login方法在会话中存储角色信息
    - _需求: 1.1, 1.2, 1.3_

  - [ ] 1.2 创建TeacherAuthManager类
    - 实现isTeacher()方法检查当前用户角色
    - 实现requireTeacher()方法进行权限验证
    - 实现getUserRole()方法获取用户角色
    - _需求: 1.4, 1.5, 7.1, 7.2, 7.6_

  - [ ] 1.3 更新注册页面支持角色选择
    - 在auth.html添加角色选择单选按钮
    - 更新js/auth.js处理角色选择
    - 添加角色选择的样式
    - _需求: 1.1_

  - [ ] 1.4 编写认证模块单元测试
    - 测试角色注册功能
    - 测试角色验证功能
    - 测试权限检查功能
    - _需求: 1.1, 1.2, 1.3_

### 阶段 2: 教师界面基础

- [ ] 2. 创建教师界面控制器
  - [ ] 2.1 创建TeacherUIController类
    - 实现initialize()方法初始化教师界面
    - 实现toggleTeacherMode()切换备课模式
    - 实现showTeacherControls()显示教师按钮
    - 实现hideTeacherControls()隐藏教师按钮
    - _需求: 1.4, 1.5, 7.4, 7.5_

  - [ ] 2.2 在index.html添加教师模式UI元素
    - 在header添加备课模式切换开关
    - 添加"添加节点"浮动按钮
    - 添加教师功能样式（styles/teacher.css）
    - _需求: 3.1, 7.4_

  - [ ] 2.3 集成TeacherUIController到main.js
    - 在应用初始化时检查用户角色
    - 根据角色显示或隐藏教师功能
    - 绑定备课模式切换事件
    - _需求: 1.4, 1.5_

  - [ ] 2.4 实现节点选择增强
    - 扩展D3VisualizationEngine支持编辑模式
    - 在节点详情面板添加"编辑节点"和"生成教案"按钮
    - 实现onNodeSelected事件处理
    - _需求: 2.1, 2.2, 2.3, 2.4_

### 阶段 3: 节点数据管理

- [ ] 3. 实现NodeDataManager
  - [ ] 3.1 创建NodeDataManager类基础结构
    - 实现loadNodes()加载节点数据
    - 实现saveNodes()保存节点数据
    - 实现数据缓存机制
    - _需求: 8.1, 8.2_

  - [ ] 3.2 实现节点ID生成
    - 实现generateNodeId()方法
    - ID格式: node-{domain}-{timestamp}-{random}
    - 确保ID唯一性
    - _需求: 3.7_

  - [ ] 3.3 实现节点创建功能
    - 实现createNode()方法
    - 验证必填字段
    - 生成节点ID
    - 添加创建时间戳和创建者信息
    - _需求: 3.5, 3.6, 3.7, 3.8, 3.9_

  - [ ] 3.4 实现节点更新功能
    - 实现updateNode()方法
    - 验证节点存在
    - 更新修改时间戳和修改者信息
    - _需求: 4.7, 4.8, 4.9_

  - [ ] 3.5 实现节点删除功能
    - 实现deleteNode()方法
    - 检查节点是否被其他节点依赖
    - 提供删除确认
    - _需求: 未明确要求，但作为完整CRUD功能_

  - [ ] 3.6 实现循环依赖检测
    - 实现detectCircularDependency()方法
    - 使用DFS算法检测循环
    - 在保存前验证前置关系
    - _需求: 9.5, 9.6_

  - [ ] 3.7 实现数据备份功能
    - 实现createBackup()方法
    - 备份文件命名: nodes-backup-{timestamp}.json
    - 保留最近10个备份
    - _需求: 8.4, 8.5_

  - [ ] 3.8 实现数据恢复功能
    - 实现restoreFromBackup()方法
    - 列出可用备份文件
    - 提供恢复确认
    - _需求: 8.6_

  - [ ] 3.9 编写NodeDataManager单元测试
    - 测试节点创建、更新、删除
    - 测试ID生成唯一性
    - 测试循环依赖检测
    - 测试备份和恢复功能
    - _需求: 3.5-3.10, 4.7-4.10, 8.1-8.6, 9.5-9.6_

### 阶段 4: 节点编辑器

- [ ] 4. 实现NodeEditor组件
  - [ ] 4.1 创建节点编辑器HTML模板
    - 创建模态对话框结构
    - 添加基本信息表单字段
    - 添加内容编辑字段
    - 添加关系设置字段
    - _需求: 3.3, 3.4, 4.1, 4.2_

  - [ ] 4.2 创建NodeEditor类
    - 实现open()方法打开编辑器
    - 实现close()方法关闭编辑器
    - 实现表单预填充逻辑
    - _需求: 2.4, 3.2, 4.1_

  - [ ] 4.3 实现表单验证
    - 实现validate()方法
    - 验证必填字段（name, nameEn, description, domains）
    - 验证数值范围（difficulty 1-5, importance 1-5）
    - 显示验证错误提示
    - _需求: 3.5, 3.6, 4.6_

  - [ ] 4.4 实现LaTeX公式预览
    - 实现renderFormulaPreview()方法
    - 使用MathJax渲染公式
    - 实时预览公式输入
    - _需求: 4.4_

  - [ ] 4.5 实现前置节点选择器
    - 创建多选下拉组件
    - 显示可选节点列表（ID和名称）
    - 支持添加和移除前置节点
    - 显示节点关系图预览
    - _需求: 4.5, 9.1, 9.2, 9.3, 9.4_

  - [ ] 4.6 实现表单提交处理
    - 实现getFormData()方法
    - 调用NodeDataManager创建或更新节点
    - 处理成功和失败情况
    - 显示提示消息
    - _需求: 3.8, 3.9, 3.10, 4.7, 4.8, 4.9, 4.10_

  - [ ] 4.7 添加节点编辑器样式
    - 创建styles/node-editor.css
    - 实现响应式布局
    - 添加表单验证错误样式
    - 添加加载和保存状态样式
    - _需求: 所有UI相关需求_

  - [ ] 4.8 编写NodeEditor单元测试
    - 测试表单验证逻辑
    - 测试数据预填充
    - 测试LaTeX预览
    - 测试前置节点选择
    - _需求: 3.3-3.10, 4.1-4.10_

### 阶段 5: 教案生成系统

- [ ] 5. 实现LessonPlanGenerator
  - [ ] 5.1 创建LessonPlanGenerator类
    - 实现generate()方法生成单个教案
    - 实现generateBatch()方法批量生成
    - 实现getDefaultTemplate()获取默认模板
    - _需求: 5.1, 5.2, 11.3, 11.4_

  - [ ] 5.2 实现默认教案模板
    - 定义教案数据结构
    - 实现各章节内容生成逻辑
    - 教学目标、知识点概述、前置知识等
    - _需求: 5.2-5.11, 6.1-6.5_

  - [ ] 5.3 实现教案内容收集
    - 从节点数据提取教案内容
    - 处理前置节点名称查询
    - 处理实际应用案例
    - 处理扩展主题
    - _需求: 5.3-5.10_

  - [ ] 5.4 实现自定义模板功能
    - 实现saveTemplate()保存模板
    - 实现loadTemplate()加载模板
    - 模板存储在localStorage
    - _需求: 6.6, 6.7, 12.7, 12.8_

  - [ ] 5.5 编写LessonPlanGenerator单元测试
    - 测试单个教案生成
    - 测试批量教案生成
    - 测试模板应用
    - 测试自定义模板保存和加载
    - _需求: 5.1-5.11, 6.1-6.7_

### 阶段 6: 教案查看和编辑

- [ ] 6. 实现LessonPlanViewer
  - [ ] 6.1 创建教案查看器HTML模板
    - 创建全屏模态对话框
    - 添加工具栏（编辑、导出、关闭）
    - 添加教案内容显示区
    - 添加侧边栏（目录、模板选择）
    - _需求: 5.11, 12.1_

  - [ ] 6.2 创建LessonPlanViewer类
    - 实现show()方法显示教案
    - 实现hide()方法关闭查看器
    - 实现目录导航功能
    - _需求: 5.11_

  - [ ] 6.3 实现教案编辑功能
    - 集成富文本编辑器（如Quill或SimpleMDE）
    - 实现实时预览
    - 支持Markdown语法
    - _需求: 12.2, 12.3, 12.4_

  - [ ] 6.4 实现教案章节管理
    - 允许添加自定义章节
    - 允许删除章节
    - 允许重新排序章节
    - _需求: 12.5, 12.6_

  - [ ] 6.5 添加教案查看器样式
    - 创建styles/lesson-plan-viewer.css
    - 实现打印友好样式
    - 添加编辑器样式
    - _需求: 所有UI相关需求_

### 阶段 7: 教案导出功能

- [ ] 7. 实现LessonPlanExporter
  - [ ] 7.1 创建LessonPlanExporter类
    - 实现exportToMarkdown()方法
    - 实现exportToHTML()方法
    - 实现downloadFile()触发下载
    - _需求: 10.2, 10.4, 10.6, 10.7_

  - [ ] 7.2 实现PDF导出功能
    - 集成jsPDF库
    - 实现exportToPDF()方法
    - 处理LaTeX公式渲染
    - 处理分页和格式
    - _需求: 10.3, 10.6, 10.8_

  - [ ] 7.3 实现导出格式选择对话框
    - 创建格式选择UI
    - 支持Markdown、PDF、HTML选择
    - 显示导出进度
    - _需求: 10.1, 10.5_

  - [ ] 7.4 实现批量导出功能
    - 支持导出为单个PDF
    - 支持导出为多个Markdown文件
    - 添加目录和分页符
    - 显示批量导出进度条
    - _需求: 11.5, 11.6, 11.7, 11.8_

  - [ ] 7.5 编写LessonPlanExporter单元测试
    - 测试Markdown导出
    - 测试HTML导出
    - 测试PDF导出
    - 测试批量导出
    - _需求: 10.1-10.8, 11.5-11.8_

### 阶段 8: 批量操作功能

- [ ] 8. 实现批量教案生成
  - [ ] 8.1 实现节点多选功能
    - 扩展D3VisualizationEngine支持多选
    - 使用Ctrl/Cmd+点击多选节点
    - 高亮显示选中的节点
    - _需求: 11.1_

  - [ ] 8.2 添加批量操作UI
    - 显示选中节点数量
    - 显示"批量生成教案"按钮
    - 添加"清除选择"按钮
    - _需求: 11.2_

  - [ ] 8.3 实现批量教案生成逻辑
    - 为每个选中节点生成教案
    - 合并所有教案为一个文档
    - 添加目录
    - 添加分页符
    - _需求: 11.3, 11.4, 11.5, 11.6_

  - [ ] 8.4 实现批量生成进度显示
    - 显示进度条
    - 显示当前处理的节点
    - 支持取消操作
    - _需求: 11.8_

### 阶段 9: 数据冲突处理

- [ ] 9. 实现数据冲突检测和解决
  - [ ] 9.1 实现数据版本控制
    - 在节点数据中添加version字段
    - 每次更新递增版本号
    - 保存lastModifiedAt时间戳
    - _需求: 8.7_

  - [ ] 9.2 实现冲突检测
    - 在保存前检查版本号
    - 比较lastModifiedAt时间戳
    - 检测是否有其他用户修改
    - _需求: 8.7, 8.8_

  - [ ] 9.3 实现冲突解决UI
    - 显示冲突提示对话框
    - 显示当前版本和服务器版本差异
    - 提供解决选项（覆盖、合并、取消）
    - _需求: 8.8_

### 阶段 10: 集成测试和优化

- [ ] 10. 集成测试
  - [ ] 10.1 测试完整节点创建流程
    - 教师登录 → 点击添加节点 → 填写表单 → 保存 → 验证数据
    - _需求: 1.1-1.5, 3.1-3.10_

  - [ ] 10.2 测试完整节点编辑流程
    - 教师登录 → 选择节点 → 编辑 → 保存 → 验证更新
    - _需求: 2.1-2.5, 4.1-4.10_

  - [ ] 10.3 测试完整教案生成流程
    - 选择节点 → 生成教案 → 预览 → 编辑 → 导出
    - _需求: 5.1-5.11, 12.1-12.9_

  - [ ] 10.4 测试批量教案生成流程
    - 多选节点 → 批量生成 → 预览 → 导出
    - _需求: 11.1-11.8_

  - [ ] 10.5 测试权限控制
    - 学生用户无法访问教师功能
    - 直接访问编辑器URL被拦截
    - 数据修改操作权限验证
    - _需求: 7.1-7.7_

  - [ ] 10.6 测试数据持久化
    - 节点创建后刷新页面验证数据
    - 节点编辑后验证更新
    - 备份和恢复功能测试
    - _需求: 8.1-8.8_

  - [ ] 10.7 测试循环依赖检测
    - 创建循环依赖场景
    - 验证检测和阻止功能
    - _需求: 9.5-9.6_

- [ ] 11. 性能优化
  - [ ] 11.1 优化数据加载
    - 实现节点数据懒加载
    - 添加数据缓存
    - 使用IndexedDB存储本地数据
    - _需求: 性能考虑_

  - [ ] 11.2 优化UI响应
    - 表单输入防抖
    - LaTeX预览节流
    - 大型教案异步生成
    - _需求: 性能考虑_

  - [ ] 11.3 优化数据保存
    - 实现自动保存草稿
    - 批量保存优化
    - 减少文件写入频率
    - _需求: 性能考虑_

### 阶段 11: 文档和部署

- [ ] 12. 编写文档
  - [ ] 12.1 创建教师功能用户指南
    - 如何注册教师账号
    - 如何创建和编辑节点
    - 如何生成和导出教案
    - 常见问题解答
    - _需求: 所有需求_

  - [ ] 12.2 创建开发者文档
    - 系统架构说明
    - 组件API文档
    - 数据模型说明
    - 扩展指南
    - _需求: 所有需求_

  - [ ] 12.3 更新项目README
    - 添加教师功能介绍
    - 更新功能列表
    - 更新安装和使用说明
    - _需求: 所有需求_

- [ ] 13. 部署准备
  - [ ] 13.1 创建生产环境配置
    - 配置数据文件路径
    - 配置备份策略
    - 配置错误日志
    - _需求: 所有需求_

  - [ ] 13.2 执行最终测试
    - 运行所有单元测试
    - 运行所有集成测试
    - 执行用户验收测试
    - _需求: 所有需求_

  - [ ] 13.3 部署到生产环境
    - 更新GitHub仓库
    - 部署到GitHub Pages
    - 验证生产环境功能
    - _需求: 所有需求_

## 检查点

### 检查点 1: 认证和权限系统（任务1-2完成后）
- 验证角色注册和登录功能
- 验证教师界面显示/隐藏逻辑
- 验证权限检查功能

### 检查点 2: 节点编辑功能（任务3-4完成后）
- 验证节点创建功能
- 验证节点编辑功能
- 验证数据持久化
- 验证循环依赖检测

### 检查点 3: 教案生成功能（任务5-7完成后）
- 验证教案生成逻辑
- 验证教案预览和编辑
- 验证教案导出功能

### 检查点 4: 完整功能验证（任务8-10完成后）
- 验证批量操作功能
- 验证数据冲突处理
- 验证所有集成测试通过

## 注意事项

1. **优先级**: 认证系统（任务1-2）> 节点编辑（任务3-4）> 教案生成（任务5-7）> 批量操作（任务8）> 优化和部署（任务9-13）
2. **依赖关系**: 任务按顺序执行，后续任务依赖前面任务的输出
3. **测试驱动**: 建议先编写单元测试，再实现功能
4. **增量开发**: 每完成一个阶段立即测试，避免问题累积
5. **代码复用**: 尽可能复用现有模块（Auth、ExportManager、UIController等）
