<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skillsç³»ç»Ÿæµ‹è¯• - çŸ¥è¯†å›¾è°±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 40px 20px;
        }

        .test-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .test-header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
            position: relative;
        }

        .back-to-graph-link {
            position: absolute;
            left: 0;
            top: 0;
            color: white;
            text-decoration: none;
            font-size: 16px;
            padding: 8px 16px;
            background: rgba(255,255,255,0.2);
            border-radius: 8px;
            transition: background 0.2s;
        }

        .back-to-graph-link:hover {
            background: rgba(255,255,255,0.3);
        }

        .test-header h1 {
            font-size: 36px;
            margin-bottom: 12px;
        }

        .test-header p {
            font-size: 18px;
            opacity: 0.9;
        }

        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 24px;
            margin-bottom: 40px;
        }

        .test-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .test-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 32px rgba(0,0,0,0.2);
        }

        .test-card h2 {
            font-size: 24px;
            color: #333;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .test-card .icon {
            font-size: 32px;
        }

        .test-card p {
            color: #666;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .test-button {
            width: 100%;
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .test-button:hover {
            background: #5568d3;
        }

        .test-button:active {
            transform: scale(0.98);
        }

        .demo-container {
            background: white;
            border-radius: 12px;
            padding: 32px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            margin-bottom: 40px;
        }

        .demo-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid #f0f0f0;
        }

        .demo-header h2 {
            font-size: 28px;
            color: #333;
        }

        .close-button {
            padding: 8px 16px;
            background: #f0f0f0;
            color: #666;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }

        .close-button:hover {
            background: #e0e0e0;
        }

        #demoContent {
            min-height: 400px;
        }

        .hidden {
            display: none !important;
        }

        .stats-panel {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .stat-item {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 14px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* æ ‡ç­¾å¯¼èˆª */
        .test-tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .test-tab {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            background: rgba(255,255,255,0.2);
            color: white;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }
        .test-tab:hover { background: rgba(255,255,255,0.3); }
        .test-tab.active { background: white; color: #667eea; }

        .platform-intro {
            background: rgba(255,255,255,0.95);
            border-radius: 10px;
            padding: 14px 20px;
            margin-bottom: 24px;
            font-size: 14px;
            color: #444;
            line-height: 1.5;
        }
        .platform-intro code { background: #f0f0f0; padding: 2px 6px; border-radius: 4px; }

        .test-panel { display: none; }
        .test-panel.active { display: block; }
        .panel-title { font-size: 22px; color: #333; margin-bottom: 8px; }
        .panel-desc { color: #666; margin-bottom: 16px; font-size: 14px; }

        /* æ³¨å†Œè¡¨ */
        .registry-section { background: white; border-radius: 12px; padding: 24px; box-shadow: 0 8px 24px rgba(0,0,0,0.1); }
        .registry-toolbar { margin-bottom: 16px; }
        .registry-select { padding: 8px 12px; border-radius: 6px; border: 1px solid #ddd; font-size: 14px; min-width: 200px; }
        .registry-table-wrap { overflow-x: auto; }
        .registry-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .registry-table th, .registry-table td { padding: 10px 12px; text-align: left; border-bottom: 1px solid #eee; }
        .registry-table th { background: #f8f9fa; font-weight: 600; color: #333; }
        .registry-table td .node-ids, .registry-table td .domain-ids { font-size: 12px; color: #555; }
        .registry-table td .skill-desc { max-width: 280px; }

        /* æŒ‰èŠ‚ç‚¹ä½“éªŒ */
        .node-experience-section { background: white; border-radius: 12px; padding: 24px; box-shadow: 0 8px 24px rgba(0,0,0,0.1); }
        .node-toolbar { margin-bottom: 16px; display: flex; align-items: center; gap: 12px; }
        .node-toolbar-status { font-size: 14px; color: #666; }
        .node-selector-row { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; margin-bottom: 20px; }
        .node-select { padding: 8px 12px; min-width: 280px; border-radius: 6px; border: 1px solid #ddd; font-size: 14px; }
        .skill-content-preview { margin-top: 20px; border: 1px solid #e0e0e0; border-radius: 10px; padding: 20px; background: #fafafa; }
        .skill-content-preview.hidden { display: none; }
        .skill-content-preview h3 { margin-bottom: 12px; color: #333; }
        .skill-content-box { font-size: 14px; line-height: 1.6; color: #333; }
        .skill-content-box .detail-section { margin-bottom: 1rem; }
        .skill-content-box .formula-display { background: #fff; padding: 8px 12px; border-radius: 6px; margin: 6px 0; overflow-x: auto; }

        /* Phase2 æ·±åº¦å†…å®¹ */
        .phase2-section { background: white; border-radius: 12px; padding: 24px; box-shadow: 0 8px 24px rgba(0,0,0,0.1); }
        .phase2-toolbar { margin-bottom: 16px; display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
        .phase2-status { font-size: 14px; color: #666; }
        .phase2-select { padding: 8px 12px; min-width: 280px; border-radius: 6px; border: 1px solid #ddd; font-size: 14px; }
        .phase2-pill { display:inline-flex; align-items:center; gap:6px; padding:2px 8px; border-radius:999px; background:#eef6ff; color:#2563eb; font-size:12px; }
        .phase2-item { border: 1px solid #e5e7eb; border-radius: 10px; background: #fff; padding: 10px 12px; margin-bottom: 10px; }
        .phase2-item summary { cursor: pointer; font-weight: 600; color: #333; }
        .phase2-kv { font-size: 13px; color: #555; margin-top: 6px; }
        .phase2-kv strong { color: #333; }
        .phase2-tags { display:flex; flex-wrap:wrap; gap:6px; margin-top: 6px; }
        .phase2-tag { font-size: 12px; padding: 2px 8px; border-radius: 999px; background: #f3f4f6; color: #374151; }
    </style>
    <link rel="stylesheet" href="js/skills/gradient-visualization/styles.css">
    <link rel="stylesheet" href="js/components/ExerciseSystem.css">
    <link rel="stylesheet" href="js/components/FeedbackSystem.css">
    <link rel="stylesheet" href="styles/skills.css">
    <script>
        MathJax = { tex: { inlineMath: [['$','$'], ['\\(','\\)']], displayMath: [['$$','$$'], ['\\[','\\]']] }, options: { skipHtmlTags: ['script','noscript','style','textarea','pre'] } };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" async></script>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <a href="index.html" class="back-to-graph-link">â† è¿”å›å›¾è°±</a>
            <h1>ğŸ¯ Skillsç³»ç»Ÿæµ‹è¯•å¹³å°</h1>
            <p>ç»„ä»¶æµ‹è¯• Â· Skill æ³¨å†Œè¡¨ä¸æ˜ å°„ Â· æŒ‰èŠ‚ç‚¹ä½“éªŒ Skill å†…å®¹ç”Ÿæˆ</p>
        </div>

        <!-- æ ‡ç­¾å¯¼èˆª -->
        <nav class="test-tabs" role="tablist" aria-label="æµ‹è¯•å¹³å°æ¨¡å—">
            <button type="button" class="test-tab active" data-tab="components" role="tab" aria-selected="true">ç»„ä»¶æµ‹è¯•</button>
            <button type="button" class="test-tab" data-tab="registry" role="tab" aria-selected="false">æ³¨å†Œè¡¨ä¸æ˜ å°„</button>
            <button type="button" class="test-tab" data-tab="phase2" role="tab" aria-selected="false">Phase2 æ·±åº¦å†…å®¹</button>
            <button type="button" class="test-tab" data-tab="node-experience" role="tab" aria-selected="false">æŒ‰èŠ‚ç‚¹ä½“éªŒ</button>
        </nav>

        <!-- å¹³å°è¯´æ˜ -->
        <div class="platform-intro">
            <p><strong>å¹³å°è¯´æ˜ï¼š</strong>ç»„ä»¶æµ‹è¯•ç”¨äºéªŒè¯æ¢¯åº¦å¯è§†åŒ–ã€é€‰æ‹©é¢˜/è®¡ç®—é¢˜/å¡«ç©º/åˆ¤æ–­é¢˜ç­‰ç»„ä»¶ï¼›æ³¨å†Œè¡¨ä¸æ˜ å°„ç”¨äºæŸ¥çœ‹æ‰€æœ‰ Skill çš„èŠ‚ç‚¹/å­¦åŸŸé€‚ç”¨èŒƒå›´ï¼›æŒ‰èŠ‚ç‚¹ä½“éªŒå¯åŠ è½½å›¾è°±æ•°æ®å¹¶é¢„è§ˆä»»æ„èŠ‚ç‚¹è§¦å‘çš„ Skill å†…å®¹ç”Ÿæˆæ•ˆæœï¼ˆä¸ä¸»åº”ç”¨ä¸€è‡´ï¼‰ã€‚</p>
        </div>

        <!-- é¢æ¿ï¼šç»„ä»¶æµ‹è¯• -->
        <section id="panel-components" class="test-panel active" role="tabpanel">
        <div class="test-grid">
            <!-- æ¢¯åº¦å¯è§†åŒ–æµ‹è¯• -->
            <div class="test-card">
                <h2><span class="icon">ğŸ¨</span> æ¢¯åº¦å¯è§†åŒ–</h2>
                <p>æµ‹è¯•3Dæ›²é¢ã€æ¢¯åº¦å‘é‡åœºå’Œç­‰é«˜çº¿çš„äº¤äº’å¼å¯è§†åŒ–</p>
                <button class="test-button" onclick="testGradientVisualization()">
                    å¯åŠ¨æµ‹è¯•
                </button>
            </div>

            <!-- é€‰æ‹©é¢˜æµ‹è¯• -->
            <div class="test-card">
                <h2><span class="icon">ğŸ“</span> é€‰æ‹©é¢˜ç³»ç»Ÿ</h2>
                <p>æµ‹è¯•å¤šé€‰é¢˜çš„æ˜¾ç¤ºã€æäº¤å’Œå³æ—¶åé¦ˆåŠŸèƒ½</p>
                <button class="test-button" onclick="testMultipleChoice()">
                    å¯åŠ¨æµ‹è¯•
                </button>
            </div>

            <!-- è®¡ç®—é¢˜æµ‹è¯• -->
            <div class="test-card">
                <h2><span class="icon">ğŸ”¢</span> è®¡ç®—é¢˜ç³»ç»Ÿ</h2>
                <p>æµ‹è¯•è®¡ç®—é¢˜çš„è¾“å…¥ã€éªŒè¯å’Œæ­¥éª¤æç¤ºåŠŸèƒ½</p>
                <button class="test-button" onclick="testCalculation()">
                    å¯åŠ¨æµ‹è¯•
                </button>
            </div>

            <!-- å¡«ç©ºé¢˜æµ‹è¯• -->
            <div class="test-card">
                <h2><span class="icon">âœï¸</span> å¡«ç©ºé¢˜ç³»ç»Ÿ</h2>
                <p>æµ‹è¯•å¡«ç©ºé¢˜çš„å¤šç©ºè¾“å…¥å’Œç­”æ¡ˆéªŒè¯åŠŸèƒ½</p>
                <button class="test-button" onclick="testFillBlanks()">
                    å¯åŠ¨æµ‹è¯•
                </button>
            </div>

            <!-- åˆ¤æ–­é¢˜æµ‹è¯• -->
            <div class="test-card">
                <h2><span class="icon">âœ“âœ—</span> åˆ¤æ–­é¢˜ç³»ç»Ÿ</h2>
                <p>æµ‹è¯•åˆ¤æ–­é¢˜çš„å¿«é€Ÿä½œç­”å’Œåé¦ˆåŠŸèƒ½</p>
                <button class="test-button" onclick="testTrueFalse()">
                    å¯åŠ¨æµ‹è¯•
                </button>
            </div>

            <!-- ç»¼åˆæµ‹è¯• -->
            <div class="test-card">
                <h2><span class="icon">ğŸ¯</span> ç»¼åˆæµ‹è¯•</h2>
                <p>æµ‹è¯•å¤šä¸ªç»„ä»¶çš„é›†æˆå’Œäº¤äº’æµç¨‹</p>
                <button class="test-button" onclick="testIntegration()">
                    å¯åŠ¨æµ‹è¯•
                </button>
            </div>
        </div>
        </section>

        <!-- é¢æ¿ï¼šæ³¨å†Œè¡¨ä¸æ˜ å°„ -->
        <section id="panel-registry" class="test-panel" role="tabpanel" hidden>
            <div class="registry-section">
                <h2 class="panel-title">ğŸ“‹ Skill æ³¨å†Œè¡¨</h2>
                <p class="panel-desc">ä»¥ä¸‹ä¸ºç³»ç»Ÿå·²æ³¨å†Œçš„ Skill åŠå…¶é€‚ç”¨çš„èŠ‚ç‚¹ IDã€å­¦åŸŸã€‚ä¸»åº”ç”¨ä¸­èŠ‚ç‚¹é€šè¿‡ <code>relatedSkills</code> ä¸æ³¨å†Œè¡¨åç§°å…³è”ã€‚</p>
                <div class="registry-toolbar">
                    <label>æŒ‰å­¦åŸŸç­›é€‰ï¼š<select id="registryDomainFilter" class="registry-select">
                        <option value="">å…¨éƒ¨å­¦åŸŸ</option>
                        <option value="domain-1">domain-1 å˜åŒ–ä¸é€¼è¿‘</option>
                        <option value="domain-2">domain-2 ç»“æ„ä¸ç´¯ç§¯</option>
                        <option value="domain-3">domain-3 ä¼˜åŒ–ä¸å†³ç­–</option>
                        <option value="domain-4">domain-4 ä¸ç¡®å®šæ€§å¤„ç†</option>
                        <option value="domain-5">domain-5 çœŸå®é—®é¢˜å»ºæ¨¡</option>
                    </select></label>
                </div>
                <div class="registry-table-wrap">
                    <table class="registry-table" id="registryTable">
                        <thead>
                            <tr>
                                <th>å›¾æ ‡</th>
                                <th>åç§°</th>
                                <th>ç±»å‹</th>
                                <th>é€‚ç”¨èŠ‚ç‚¹</th>
                                <th>é€‚ç”¨å­¦åŸŸ</th>
                                <th>æè¿°</th>
                            </tr>
                        </thead>
                        <tbody id="registryTableBody"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- é¢æ¿ï¼šPhase2 æ·±åº¦å†…å®¹ -->
        <section id="panel-phase2" class="test-panel" role="tabpanel" hidden>
            <div class="phase2-section">
                <h2 class="panel-title">ğŸ“¦ Phase2 Skills æ·±åº¦å†…å®¹</h2>
                <p class="panel-desc">ä» <code>data/skills-content-phase2.json</code> åŠ è½½è¿›é˜¶ä¸»é¢˜ï¼ˆadvancedTopicsï¼‰ã€è¿›é˜¶ç»ƒä¹ ï¼ˆadvancedExercisesï¼‰ä¸é¡¹ç›®ä»»åŠ¡ï¼ˆprojectsï¼‰ï¼Œç”¨äºéªŒè¯ä½ åˆšè¡¥å……çš„æ·±åº¦å†…å®¹æ˜¯å¦å¯è§ã€‚</p>
                <div class="phase2-toolbar">
                    <button type="button" class="test-button" id="btnLoadPhase2Deep" style="width:auto;">åŠ è½½ Phase2 æ·±åº¦å†…å®¹</button>
                    <span class="phase2-status" id="phase2Status">æœªåŠ è½½</span>
                </div>
                <div class="phase2-toolbar">
                    <label>é€‰æ‹© Skillï¼š<select id="phase2SkillSelect" class="phase2-select" disabled><option value="">è¯·å…ˆåŠ è½½ Phase2 æ·±åº¦å†…å®¹</option></select></label>
                    <button type="button" class="test-button" id="btnRenderPhase2" style="width:auto;" disabled>æ˜¾ç¤ºå†…å®¹</button>
                </div>
                <div id="phase2Preview" class="skill-content-preview hidden">
                    <h3>æ·±åº¦å†…å®¹é¢„è§ˆ</h3>
                    <div id="phase2Box" class="skill-content-box"></div>
                </div>
            </div>
        </section>

        <!-- é¢æ¿ï¼šæŒ‰èŠ‚ç‚¹ä½“éªŒ -->
        <section id="panel-node-experience" class="test-panel" role="tabpanel" hidden>
            <div class="node-experience-section">
                <h2 class="panel-title">ğŸ”— æŒ‰èŠ‚ç‚¹ä½“éªŒ Skill å†…å®¹</h2>
                <p class="panel-desc">åŠ è½½å›¾è°±æ•°æ®åï¼Œé€‰æ‹©èŠ‚ç‚¹å¯é¢„è§ˆä¸»åº”ç”¨ä¸­ã€Œå»è¿ç”¨ã€æ—¶ç”Ÿæˆçš„ Skill å†…å®¹ï¼ˆå…¬å¼ã€å‰ç½®/å»¶ä¼¸ã€å…³é”®è¯ã€å­¦ä¹ å»ºè®®ç­‰ï¼‰ã€‚</p>
                <div class="node-toolbar">
                    <button type="button" class="test-button" id="btnLoadGraphData">åŠ è½½å›¾è°±æ•°æ®</button>
                    <span class="node-toolbar-status" id="nodeDataStatus">æœªåŠ è½½</span>
                </div>
                <div class="node-selector-row">
                    <label>é€‰æ‹©èŠ‚ç‚¹ï¼š<select id="nodeSelect" class="node-select" disabled><option value="">è¯·å…ˆåŠ è½½å›¾è°±æ•°æ®</option></select></label>
                    <button type="button" class="test-button" id="btnGenerateSkillContent" disabled>ç”Ÿæˆ Skill å†…å®¹</button>
                </div>
                <div id="nodeSkillContentPreview" class="skill-content-preview hidden">
                    <h3>ç”Ÿæˆå†…å®¹é¢„è§ˆ</h3>
                    <div id="nodeSkillContentBox" class="skill-content-box"></div>
                </div>
            </div>
        </section>

        <!-- æ¼”ç¤ºå®¹å™¨ -->
        <div id="demoContainer" class="demo-container hidden">
            <div class="demo-header">
                <h2 id="demoTitle">æµ‹è¯•æ¼”ç¤º</h2>
                <button class="close-button" onclick="closeDemo()">å…³é—­</button>
            </div>
            <div id="demoContent"></div>
        </div>

        <!-- ç»Ÿè®¡é¢æ¿ -->
        <div class="stats-panel">
            <h2 style="margin-bottom: 20px; color: #333;">ğŸ“Š æµ‹è¯•ç»Ÿè®¡</h2>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value" id="statTests">0</div>
                    <div class="stat-label">æµ‹è¯•æ¬¡æ•°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="statScore">0</div>
                    <div class="stat-label">æ­£ç¡®ç­”æ¡ˆ</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="statAccuracy">0%</div>
                    <div class="stat-label">å‡†ç¡®ç‡</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="statTime">0s</div>
                    <div class="stat-label">æ€»ç”¨æ—¶</div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { GradientVisualizationSkill } from './js/skills/gradient-visualization/index.js';
        import { ExerciseSystem } from './js/components/ExerciseSystem.js';
        import { FeedbackSystem } from './js/components/FeedbackSystem.js';
        import { SkillIntegrationManager } from './js/modules/SkillIntegrationManager.js';
        import { SkillContentManager } from './js/modules/SkillContentManager.js';
        import { DomainDataManager } from './js/modules/DomainDataManager.js';
        import { KnowledgeGraphEngine } from './js/modules/KnowledgeGraphEngine.js';
        import { generateSkillContent, inferNodeType } from './js/modules/SkillContentGenerator.js';

        // å…¨å±€å˜é‡
        window.currentSkill = null;
        window.exerciseSystem = null;
        window.feedbackSystem = new FeedbackSystem();
        window.skillManager = new SkillIntegrationManager();
        window.skillContentManager = new SkillContentManager();
        window.domainManager = null;
        window.graphEngine = null;
        window.testStats = { tests: 0, score: 0, startTime: Date.now() };

        // ---------- æ ‡ç­¾åˆ‡æ¢ ----------
        document.querySelectorAll('.test-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const id = tab.getAttribute('data-tab');
                document.querySelectorAll('.test-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.test-panel').forEach(p => { p.classList.remove('active'); p.hidden = true; });
                tab.classList.add('active');
                const panel = document.getElementById('panel-' + id.replace(/-/g, '-'));
                if (panel) { panel.classList.add('active'); panel.hidden = false; }
            });
        });

        // ---------- Skill æ³¨å†Œè¡¨ ----------
        async function initRegistry() {
            await window.skillManager.loadSkillRegistry();
            renderRegistryTable();
            document.getElementById('registryDomainFilter').addEventListener('change', () => renderRegistryTable());
        }
        function renderRegistryTable() {
            const domainFilter = document.getElementById('registryDomainFilter').value;
            let skills = domainFilter
                ? window.skillManager.getSkillsByDomain(domainFilter)
                : window.skillManager.getAllSkills();
            const tbody = document.getElementById('registryTableBody');
            tbody.innerHTML = skills.map(s => `
                <tr>
                    <td>${s.icon || 'â€”'}</td>
                    <td><strong>${escapeHtml(s.name)}</strong></td>
                    <td>${escapeHtml(s.type || 'â€”')}</td>
                    <td class="node-ids">${(s.applicableNodes || []).join(', ') || 'â€”'}</td>
                    <td class="domain-ids">${(s.applicableDomains || []).join(', ') || 'â€”'}</td>
                    <td class="skill-desc">${escapeHtml(s.description || '')}</td>
                </tr>
            `).join('');
        }
        function escapeHtml(str) {
            if (!str) return '';
            const d = document.createElement('div');
            d.textContent = str;
            return d.innerHTML;
        }

        // ---------- æŒ‰èŠ‚ç‚¹ä½“éªŒ ----------
        document.getElementById('btnLoadGraphData').addEventListener('click', async () => {
            const btn = document.getElementById('btnLoadGraphData');
            const status = document.getElementById('nodeDataStatus');
            const nodeSelect = document.getElementById('nodeSelect');
            const btnGen = document.getElementById('btnGenerateSkillContent');
            btn.disabled = true;
            status.textContent = 'åŠ è½½ä¸­â€¦';
            try {
                const [domainsData, nodesData, edgesData] = await Promise.all([
                    fetch('data/domains.json').then(r => r.json()),
                    fetch('data/nodes.json').then(r => r.json()),
                    fetch('data/edges.json').then(r => r.json())
                ]);
                window.domainManager = new DomainDataManager(domainsData);
                const nodes = nodesData.nodes || [];
                const edges = (edgesData.edges || []).map(e => ({
                    ...e,
                    source: typeof e.source === 'object' ? e.source.id : e.source,
                    target: typeof e.target === 'object' ? e.target.id : e.target
                }));
                nodes.forEach(n => { n.type = n.type || inferNodeType(n); });
                window.graphEngine = new KnowledgeGraphEngine(nodes, edges);
                nodeSelect.innerHTML = nodes.map(n => `<option value="${escapeHtml(n.id)}">${escapeHtml(n.name)}</option>`).join('');
                nodeSelect.disabled = false;
                btnGen.disabled = false;
                status.textContent = `å·²åŠ è½½ ${nodes.length} èŠ‚ç‚¹`;
            } catch (err) {
                status.textContent = 'åŠ è½½å¤±è´¥: ' + err.message;
                console.error(err);
            }
            btn.disabled = false;
        });
        document.getElementById('btnGenerateSkillContent').addEventListener('click', () => {
            if (!window.graphEngine || !window.domainManager) return;
            const nodeId = document.getElementById('nodeSelect').value;
            if (!nodeId) return;
            const node = window.graphEngine.getNode(nodeId);
            if (!node) return;
            const html = generateSkillContent(node, window.domainManager, window.graphEngine);
            const box = document.getElementById('nodeSkillContentBox');
            const preview = document.getElementById('nodeSkillContentPreview');
            box.innerHTML = html;
            preview.classList.remove('hidden');
            if (window.MathJax && window.MathJax.typesetPromise) {
                window.MathJax.typesetPromise([box]).catch(e => console.warn('MathJax:', e));
            }
        });

        initRegistry();

        // ---------- Phase2 æ·±åº¦å†…å®¹ ----------
        (function initPhase2DeepPanel() {
            const btnLoad = document.getElementById('btnLoadPhase2Deep');
            const status = document.getElementById('phase2Status');
            const select = document.getElementById('phase2SkillSelect');
            const btnRender = document.getElementById('btnRenderPhase2');
            const preview = document.getElementById('phase2Preview');
            const box = document.getElementById('phase2Box');

            function esc(s) {
                if (s == null) return '';
                const d = document.createElement('div');
                d.textContent = String(s);
                return d.innerHTML;
            }

            function renderDeepSkill(skill) {
                if (!skill) return '<p>æœªæ‰¾åˆ°è¯¥ Skill çš„ Phase2 æ·±åº¦å†…å®¹ã€‚</p>';
                const topics = Array.isArray(skill.advancedTopics) ? skill.advancedTopics : [];
                const exercises = Array.isArray(skill.advancedExercises) ? skill.advancedExercises : [];
                const projects = Array.isArray(skill.projects) ? skill.projects : [];
                const md = skill.metadata || {};

                let html = `
                    <div class="detail-section">
                        <h3>ğŸ¯ Skillï¼š${esc(skill.skillId)}</h3>
                        <p class="phase2-kv"><span class="phase2-pill">topics ${topics.length}</span> <span class="phase2-pill">exercises ${exercises.length}</span> <span class="phase2-pill">projects ${projects.length}</span></p>
                    </div>
                `;

                // Topics
                html += `<div class="detail-section"><h3>ğŸ“š è¿›é˜¶ä¸»é¢˜ï¼ˆadvancedTopicsï¼‰</h3>`;
                if (!topics.length) {
                    html += `<p>æš‚æ— è¿›é˜¶ä¸»é¢˜ã€‚</p>`;
                } else {
                    topics.forEach(t => {
                        const examples = Array.isArray(t.examples) ? t.examples : [];
                        const apps = Array.isArray(t.applications) ? t.applications : [];
                        html += `
                            <div class="phase2-item">
                                <div><strong>${esc(t.title || '')}</strong></div>
                                ${t.description ? `<div class="phase2-kv">${esc(t.description)}</div>` : ''}
                                ${t.formula ? `<div class="formula-display">\\[${t.formula}\\]</div>` : ''}
                                ${examples.length ? `<div class="phase2-kv"><strong>ä¾‹ï¼š</strong><ul>${examples.map(e => `<li>${esc(e)}</li>`).join('')}</ul></div>` : ''}
                                ${apps.length ? `<div class="phase2-kv"><strong>åº”ç”¨ï¼š</strong>${apps.map(a => `<span class="phase2-tag">${esc(a)}</span>`).join(' ')}</div>` : ''}
                            </div>
                        `;
                    });
                }
                html += `</div>`;

                // Exercises
                html += `<div class="detail-section"><h3>ğŸ“ è¿›é˜¶ç»ƒä¹ ï¼ˆadvancedExercisesï¼‰</h3>`;
                if (!exercises.length) {
                    html += `<p>æš‚æ— è¿›é˜¶ç»ƒä¹ ã€‚</p>`;
                } else {
                    exercises.forEach(ex => {
                        const hints = Array.isArray(ex.hints) ? ex.hints : [];
                        const steps = Array.isArray(ex.solution?.steps) ? ex.solution.steps : [];
                        const keyPoints = Array.isArray(ex.solution?.keyPoints) ? ex.solution.keyPoints : [];
                        html += `
                            <details class="phase2-item">
                                <summary>${esc(ex.id || '')} Â· éš¾åº¦ ${esc(ex.difficulty ?? '-')} Â· ${esc(ex.question || '')}</summary>
                                ${hints.length ? `<div class="phase2-kv"><strong>æç¤ºï¼š</strong><ul>${hints.map(h => `<li>${esc(h)}</li>`).join('')}</ul></div>` : ''}
                                ${steps.length ? `<div class="phase2-kv"><strong>è§£ç­”å…³é”®æ­¥éª¤ï¼š</strong><ol>${steps.map(s => `<li>${esc(s)}</li>`).join('')}</ol></div>` : ''}
                                ${keyPoints.length ? `<div class="phase2-kv"><strong>è¦ç‚¹ï¼š</strong><div class="phase2-tags">${keyPoints.map(k => `<span class="phase2-tag">${esc(k)}</span>`).join('')}</div></div>` : ''}
                                ${ex.estimatedTime ? `<div class="phase2-kv">â±ï¸ é¢„è®¡ç”¨æ—¶ï¼š${esc(ex.estimatedTime)} åˆ†é’Ÿ</div>` : ''}
                            </details>
                        `;
                    });
                }
                html += `</div>`;

                // Projects
                html += `<div class="detail-section"><h3>ğŸ§© é¡¹ç›®ä»»åŠ¡ï¼ˆprojectsï¼‰</h3>`;
                if (!projects.length) {
                    html += `<p>æš‚æ— é¡¹ç›®ä»»åŠ¡ã€‚</p>`;
                } else {
                    projects.forEach(p => {
                        const obj = Array.isArray(p.objectives) ? p.objectives : [];
                        const tasks = Array.isArray(p.tasks) ? p.tasks : [];
                        const deliverables = Array.isArray(p.deliverables) ? p.deliverables : [];
                        html += `
                            <details class="phase2-item">
                                <summary>${esc(p.id || '')} Â· éš¾åº¦ ${esc(p.difficulty ?? '-')} Â· ${esc(p.title || '')}</summary>
                                ${p.description ? `<div class="phase2-kv">${esc(p.description)}</div>` : ''}
                                ${obj.length ? `<div class="phase2-kv"><strong>ç›®æ ‡ï¼š</strong><ul>${obj.map(o => `<li>${esc(o)}</li>`).join('')}</ul></div>` : ''}
                                ${tasks.length ? `<div class="phase2-kv"><strong>ä»»åŠ¡ï¼š</strong><ol>${tasks.map(t => `<li><strong>Step ${esc(t.step ?? '')}</strong>ï¼š${esc(t.description || '')}${t.code ? `<pre class="formula-display"><code>${esc(t.code)}</code></pre>` : ''}${t.visualization ? `<div class="phase2-kv"><strong>å¯è§†åŒ–ï¼š</strong>${esc(t.visualization)}</div>` : ''}</li>`).join('')}</ol></div>` : ''}
                                ${deliverables.length ? `<div class="phase2-kv"><strong>äº¤ä»˜ç‰©ï¼š</strong>${deliverables.map(d => `<span class="phase2-tag">${esc(d)}</span>`).join(' ')}</div>` : ''}
                                ${p.estimatedTime ? `<div class="phase2-kv">â±ï¸ é¢„è®¡ç”¨æ—¶ï¼š${esc(p.estimatedTime)} åˆ†é’Ÿ</div>` : ''}
                            </details>
                        `;
                    });
                }
                html += `</div>`;

                if (md && (md.totalTopics || md.totalExercises || md.totalProjects)) {
                    html += `<div class="detail-section"><h3>ğŸ“Œ å…ƒæ•°æ®</h3><p class="phase2-kv">topics: ${esc(md.totalTopics ?? '-')} Â· exercises: ${esc(md.totalExercises ?? '-')} Â· projects: ${esc(md.totalProjects ?? '-')}</p></div>`;
                }
                return html;
            }

            async function loadPhase2() {
                btnLoad.disabled = true;
                status.textContent = 'åŠ è½½ä¸­â€¦';
                try {
                    await window.skillContentManager.initialize();
                    const { totalItems, skillIds } = await window.skillContentManager.loadPhase2DeepContent('data/skills-content-phase2.json');
                    select.innerHTML = '<option value=\"\">è¯·é€‰æ‹© Skill</option>' + skillIds.map(id => `<option value=\"${esc(id)}\">${esc(id)}</option>`).join('');
                    select.disabled = false;
                    btnRender.disabled = false;
                    status.textContent = `å·²åŠ è½½ ${totalItems} ä¸ª Skill`;
                } catch (e) {
                    status.textContent = 'åŠ è½½å¤±è´¥ï¼š' + e.message;
                    console.error(e);
                } finally {
                    btnLoad.disabled = false;
                }
            }

            function renderSelected() {
                const id = select.value;
                if (!id) return;
                const skill = window.skillContentManager.getPhase2Skill(id);
                box.innerHTML = renderDeepSkill(skill);
                preview.classList.remove('hidden');
                if (window.MathJax && window.MathJax.typesetPromise) {
                    window.MathJax.typesetPromise([box]).catch(e => console.warn('MathJax:', e));
                }
            }

            btnLoad.addEventListener('click', loadPhase2);
            btnRender.addEventListener('click', renderSelected);
            select.addEventListener('change', () => { if (select.value) renderSelected(); });
        })();

        // æ¢¯åº¦å¯è§†åŒ–æµ‹è¯•
        window.testGradientVisualization = function() {
            showDemo('ğŸ¨ æ¢¯åº¦å¯è§†åŒ–æµ‹è¯•');
            const container = document.getElementById('demoContent');
            
            if (window.currentSkill) {
                window.currentSkill.destroy();
            }
            
            window.currentSkill = new GradientVisualizationSkill(container);
            window.currentSkill.init();
            
            updateStats();
        };

        // é€‰æ‹©é¢˜æµ‹è¯•
        window.testMultipleChoice = function() {
            showDemo('ğŸ“ é€‰æ‹©é¢˜æµ‹è¯•');
            const container = document.getElementById('demoContent');
            
            if (!window.exerciseSystem) {
                window.exerciseSystem = new ExerciseSystem(container);
            }
            
            const exercise = {
                type: 'multiple-choice',
                difficulty: 'intermediate',
                question: 'å‡½æ•° f(x,y) = xÂ² + yÂ² åœ¨ç‚¹ (1,2) å¤„çš„æ¢¯åº¦æ˜¯ä»€ä¹ˆï¼Ÿ',
                options: [
                    'âˆ‡f(1,2) = (1, 2)',
                    'âˆ‡f(1,2) = (2, 4)',
                    'âˆ‡f(1,2) = (2, 2)',
                    'âˆ‡f(1,2) = (4, 2)'
                ],
                answer: 1,
                explanation: 'å¯¹xæ±‚åå¯¼å¾— âˆ‚f/âˆ‚x = 2xï¼Œå¯¹yæ±‚åå¯¼å¾— âˆ‚f/âˆ‚y = 2yã€‚åœ¨ç‚¹(1,2)å¤„ï¼Œæ¢¯åº¦ä¸º (2Ã—1, 2Ã—2) = (2, 4)ã€‚'
            };
            
            window.exerciseSystem.showExercise(exercise);
            updateStats();
        };

        // è®¡ç®—é¢˜æµ‹è¯•
        window.testCalculation = function() {
            showDemo('ğŸ”¢ è®¡ç®—é¢˜æµ‹è¯•');
            const container = document.getElementById('demoContent');
            
            if (!window.exerciseSystem) {
                window.exerciseSystem = new ExerciseSystem(container);
            }
            
            const exercise = {
                type: 'calculation',
                difficulty: 'basic',
                question: 'è®¡ç®—æé™: lim(xâ†’0) (sin x) / x',
                answer: '1',
                explanation: 'è¿™æ˜¯ä¸€ä¸ªé‡è¦æé™ã€‚ä½¿ç”¨æ´›å¿…è¾¾æ³•åˆ™æˆ–æ³°å‹’å±•å¼€éƒ½å¯ä»¥å¾—åˆ°ç»“æœä¸º1ã€‚'
            };
            
            window.exerciseSystem.showExercise(exercise);
            updateStats();
        };

        // å¡«ç©ºé¢˜æµ‹è¯•
        window.testFillBlanks = function() {
            showDemo('âœï¸ å¡«ç©ºé¢˜æµ‹è¯•');
            const container = document.getElementById('demoContent');
            
            if (!window.exerciseSystem) {
                window.exerciseSystem = new ExerciseSystem(container);
            }
            
            const exercise = {
                type: 'fill-blanks',
                difficulty: 'intermediate',
                question: 'å¯¼æ•°çš„å®šä¹‰æ˜¯: f\'(x) = lim(hâ†’___) [f(x+h) - f(x)] / ___',
                blanks: ['0', 'h'],
                answers: ['0', 'h'],
                explanation: 'å¯¼æ•°å®šä¹‰ä½¿ç”¨æé™ï¼Œå½“hè¶‹å‘äº0æ—¶ï¼Œå·®å•†çš„æé™å°±æ˜¯å¯¼æ•°ã€‚'
            };
            
            window.exerciseSystem.showExercise(exercise);
            updateStats();
        };

        // åˆ¤æ–­é¢˜æµ‹è¯•
        window.testTrueFalse = function() {
            showDemo('âœ“âœ— åˆ¤æ–­é¢˜æµ‹è¯•');
            const container = document.getElementById('demoContent');
            
            if (!window.exerciseSystem) {
                window.exerciseSystem = new ExerciseSystem(container);
            }
            
            const exercise = {
                type: 'true-false',
                difficulty: 'basic',
                question: 'æ¢¯åº¦å‘é‡æ€»æ˜¯æŒ‡å‘å‡½æ•°å€¼å¢é•¿æœ€å¿«çš„æ–¹å‘ã€‚',
                answer: true,
                explanation: 'æ­£ç¡®ï¼æ¢¯åº¦å‘é‡çš„æ–¹å‘å°±æ˜¯å‡½æ•°åœ¨è¯¥ç‚¹å¢é•¿æœ€å¿«çš„æ–¹å‘ï¼Œå…¶æ¨¡é•¿è¡¨ç¤ºæœ€å¤§å˜åŒ–ç‡ã€‚'
            };
            
            window.exerciseSystem.showExercise(exercise);
            updateStats();
        };

        // ç»¼åˆæµ‹è¯•
        window.testIntegration = function() {
            showDemo('ğŸ¯ ç»¼åˆæµ‹è¯•');
            const container = document.getElementById('demoContent');
            
            container.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <h3 style="font-size: 24px; color: #333; margin-bottom: 20px;">
                        ğŸ‰ æ‰€æœ‰ç»„ä»¶æµ‹è¯•å®Œæˆï¼
                    </h3>
                    <p style="font-size: 16px; color: #666; margin-bottom: 30px;">
                        Skillsç³»ç»Ÿå·²å‡†å¤‡å°±ç»ªï¼Œå¯ä»¥é›†æˆåˆ°ä¸»åº”ç”¨ä¸­ã€‚
                    </p>
                    <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                        <button class="test-button" style="width: auto;" onclick="window.feedbackSystem.showFeedbackForm({type: 'ç³»ç»Ÿæµ‹è¯•'})">
                            ğŸ“ æäº¤åé¦ˆ
                        </button>
                        <button class="test-button" style="width: auto; background: #28a745;" onclick="window.feedbackSystem.showFeedbackStats()">
                            ğŸ“Š æŸ¥çœ‹ç»Ÿè®¡
                        </button>
                        <button class="test-button" style="width: auto; background: #17a2b8;" onclick="window.feedbackSystem.exportFeedback()">
                            ğŸ’¾ å¯¼å‡ºæ•°æ®
                        </button>
                        <button class="test-button" style="width: auto;" onclick="location.href='index.html'">
                            ğŸ  è¿”å›ä¸»åº”ç”¨
                        </button>
                    </div>
                </div>
            `;
            
            updateStats();
        };

        // æ˜¾ç¤ºæ¼”ç¤º
        window.showDemo = function(title) {
            document.getElementById('demoTitle').textContent = title;
            document.getElementById('demoContainer').classList.remove('hidden');
            window.testStats.tests++;
        };

        // å…³é—­æ¼”ç¤º
        window.closeDemo = function() {
            document.getElementById('demoContainer').classList.add('hidden');
            if (window.currentSkill) {
                window.currentSkill.destroy();
                window.currentSkill = null;
            }
        };

        // æ›´æ–°ç»Ÿè®¡
        window.updateStats = function() {
            document.getElementById('statTests').textContent = window.testStats.tests;
            
            if (window.exerciseSystem) {
                const stats = window.exerciseSystem.getStats();
                document.getElementById('statScore').textContent = stats.score;
                document.getElementById('statAccuracy').textContent = stats.accuracy + '%';
            }
            
            const elapsed = Math.floor((Date.now() - window.testStats.startTime) / 1000);
            document.getElementById('statTime').textContent = elapsed + 's';
        };

        // å®šæœŸæ›´æ–°æ—¶é—´
        setInterval(() => {
            const elapsed = Math.floor((Date.now() - window.testStats.startTime) / 1000);
            document.getElementById('statTime').textContent = elapsed + 's';
        }, 1000);

        console.log('âœ… Skillsæµ‹è¯•ç³»ç»Ÿå·²åŠ è½½');
    </script>
</body>
</html>
