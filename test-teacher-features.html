<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•™å¸ˆåŠŸèƒ½æµ‹è¯• - çŸ¥è¯†å›¾è°±ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="styles/auth.css">
    <style>
        .test-container {
            max-width: 800px;
            margin: 40px auto;
            padding: 30px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }
        .test-section h3 {
            color: #667eea;
            margin-bottom: 15px;
        }
        .test-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .test-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        .test-result {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            font-family: monospace;
            font-size: 13px;
            white-space: pre-wrap;
        }
        .success { color: #27ae60; }
        .error { color: #e74c3c; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ§ª æ•™å¸ˆåŠŸèƒ½æµ‹è¯•</h1>
        <p>æµ‹è¯•æ•™å¸ˆå¤‡è¯¾åŠŸèƒ½çš„å„ä¸ªæ¨¡å—</p>
        
        <!-- Auth Test -->
        <div class="test-section">
            <h3>1. è®¤è¯ç³»ç»Ÿæµ‹è¯•</h3>
            <button class="test-btn" onclick="testAuth()">æµ‹è¯•è§’è‰²ç®¡ç†</button>
            <button class="test-btn" onclick="testTeacherCheck()">æµ‹è¯•æ•™å¸ˆæƒé™</button>
            <div id="authResult" class="test-result" style="display:none;"></div>
        </div>
        
        <!-- Node Data Manager Test -->
        <div class="test-section">
            <h3>2. èŠ‚ç‚¹æ•°æ®ç®¡ç†æµ‹è¯•</h3>
            <button class="test-btn" onclick="testNodeCreate()">æµ‹è¯•åˆ›å»ºèŠ‚ç‚¹</button>
            <button class="test-btn" onclick="testNodeUpdate()">æµ‹è¯•æ›´æ–°èŠ‚ç‚¹</button>
            <button class="test-btn" onclick="testCircularDependency()">æµ‹è¯•å¾ªç¯ä¾èµ–æ£€æµ‹</button>
            <div id="nodeResult" class="test-result" style="display:none;"></div>
        </div>
        
        <!-- Lesson Plan Generator Test -->
        <div class="test-section">
            <h3>3. æ•™æ¡ˆç”Ÿæˆæµ‹è¯•</h3>
            <button class="test-btn" onclick="testLessonPlanGenerate()">æµ‹è¯•ç”Ÿæˆæ•™æ¡ˆ</button>
            <button class="test-btn" onclick="testBatchGenerate()">æµ‹è¯•æ‰¹é‡ç”Ÿæˆ</button>
            <div id="lessonResult" class="test-result" style="display:none;"></div>
        </div>
        
        <!-- UI Test -->
        <div class="test-section">
            <h3>4. UIç»„ä»¶æµ‹è¯•</h3>
            <button class="test-btn" onclick="testNodeEditor()">æ‰“å¼€èŠ‚ç‚¹ç¼–è¾‘å™¨</button>
            <button class="test-btn" onclick="testLessonViewer()">æ‰“å¼€æ•™æ¡ˆæŸ¥çœ‹å™¨</button>
            <div id="uiResult" class="test-result" style="display:none;"></div>
        </div>
        
        <div class="test-section">
            <h3>è¿”å›</h3>
            <a href="index.html" class="test-btn" style="display:inline-block; text-decoration:none;">è¿”å›ä¸»åº”ç”¨</a>
            <a href="auth.html" class="test-btn" style="display:inline-block; text-decoration:none;">è¿”å›ç™»å½•</a>
        </div>
    </div>
    
    <script type="module">
        import { auth } from './js/modules/Auth.js';
        import { nodeDataManager } from './js/modules/NodeDataManager.js';
        import { lessonPlanGenerator } from './js/modules/LessonPlanGenerator.js';
        import { nodeEditor } from './js/modules/NodeEditor.js';
        import { lessonPlanViewer } from './js/modules/LessonPlanViewer.js';
        
        // Make modules globally available for testing
        window.auth = auth;
        window.nodeDataManager = nodeDataManager;
        window.lessonPlanGenerator = lessonPlanGenerator;
        window.nodeEditor = nodeEditor;
        window.lessonPlanViewer = lessonPlanViewer;
        
        // Initialize
        async function init() {
            await nodeDataManager.loadNodes();
            nodeEditor.initialize();
            lessonPlanViewer.initialize();
            console.log('Test environment initialized');
        }
        
        init();
        
        // Test functions
        window.testAuth = function() {
            const result = document.getElementById('authResult');
            result.style.display = 'block';
            
            const user = auth.getCurrentUser();
            const isTeacher = auth.isTeacher();
            const role = auth.getUserRole();
            
            result.innerHTML = `
å½“å‰ç”¨æˆ·: ${user ? user.username : 'æœªç™»å½•'}
ç”¨æˆ·è§’è‰²: ${role || 'æ— '}
æ˜¯å¦æ•™å¸ˆ: ${isTeacher ? 'æ˜¯' : 'å¦'}
è®¤è¯çŠ¶æ€: ${auth.isAuthenticated() ? 'å·²è®¤è¯' : 'æœªè®¤è¯'}
            `;
        };
        
        window.testTeacherCheck = function() {
            const result = document.getElementById('authResult');
            result.style.display = 'block';
            
            if (auth.isTeacher()) {
                result.innerHTML = '<span class="success">âœ… æ•™å¸ˆæƒé™éªŒè¯é€šè¿‡</span>';
            } else {
                result.innerHTML = '<span class="error">âŒ å½“å‰ç”¨æˆ·ä¸æ˜¯æ•™å¸ˆ</span>';
            }
        };
        
        window.testNodeCreate = function() {
            const result = document.getElementById('nodeResult');
            result.style.display = 'block';
            
            const testNode = {
                name: 'æµ‹è¯•èŠ‚ç‚¹',
                nameEn: 'Test Node',
                description: 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•èŠ‚ç‚¹',
                domains: ['domain-1'],
                difficulty: 3,
                importance: 3
            };
            
            const createResult = nodeDataManager.createNode(testNode);
            
            if (createResult.success) {
                result.innerHTML = `<span class="success">âœ… èŠ‚ç‚¹åˆ›å»ºæˆåŠŸ</span>\n${JSON.stringify(createResult.node, null, 2)}`;
            } else {
                result.innerHTML = `<span class="error">âŒ èŠ‚ç‚¹åˆ›å»ºå¤±è´¥: ${createResult.message}</span>`;
            }
        };
        
        window.testNodeUpdate = function() {
            const result = document.getElementById('nodeResult');
            result.style.display = 'block';
            
            const nodes = nodeDataManager.getAllNodes();
            if (nodes.length === 0) {
                result.innerHTML = '<span class="error">âŒ æ²¡æœ‰å¯æ›´æ–°çš„èŠ‚ç‚¹</span>';
                return;
            }
            
            const node = nodes[0];
            const updateResult = nodeDataManager.updateNode(node.id, {
                description: 'æ›´æ–°åçš„æè¿° - ' + new Date().toLocaleTimeString()
            });
            
            if (updateResult.success) {
                result.innerHTML = `<span class="success">âœ… èŠ‚ç‚¹æ›´æ–°æˆåŠŸ</span>\n${JSON.stringify(updateResult.node, null, 2)}`;
            } else {
                result.innerHTML = `<span class="error">âŒ èŠ‚ç‚¹æ›´æ–°å¤±è´¥: ${updateResult.message}</span>`;
            }
        };
        
        window.testCircularDependency = function() {
            const result = document.getElementById('nodeResult');
            result.style.display = 'block';
            
            // Create test nodes with circular dependency
            const node1 = nodeDataManager.createNode({
                name: 'èŠ‚ç‚¹A',
                nameEn: 'Node A',
                description: 'æµ‹è¯•èŠ‚ç‚¹A',
                domains: ['domain-1']
            });
            
            if (!node1.success) {
                result.innerHTML = `<span class="error">âŒ åˆ›å»ºèŠ‚ç‚¹Aå¤±è´¥</span>`;
                return;
            }
            
            const node2 = nodeDataManager.createNode({
                name: 'èŠ‚ç‚¹B',
                nameEn: 'Node B',
                description: 'æµ‹è¯•èŠ‚ç‚¹B',
                domains: ['domain-1'],
                prerequisites: [node1.node.id]
            });
            
            if (!node2.success) {
                result.innerHTML = `<span class="error">âŒ åˆ›å»ºèŠ‚ç‚¹Bå¤±è´¥</span>`;
                return;
            }
            
            // Try to create circular dependency
            const updateResult = nodeDataManager.updateNode(node1.node.id, {
                prerequisites: [node2.node.id]
            });
            
            if (!updateResult.success && updateResult.message.includes('å¾ªç¯ä¾èµ–')) {
                result.innerHTML = `<span class="success">âœ… å¾ªç¯ä¾èµ–æ£€æµ‹æˆåŠŸ</span>\né”™è¯¯ä¿¡æ¯: ${updateResult.message}`;
            } else {
                result.innerHTML = `<span class="error">âŒ å¾ªç¯ä¾èµ–æ£€æµ‹å¤±è´¥</span>`;
            }
        };
        
        window.testLessonPlanGenerate = function() {
            const result = document.getElementById('lessonResult');
            result.style.display = 'block';
            
            const nodes = nodeDataManager.getAllNodes();
            if (nodes.length === 0) {
                result.innerHTML = '<span class="error">âŒ æ²¡æœ‰å¯ç”¨çš„èŠ‚ç‚¹</span>';
                return;
            }
            
            const node = nodes[0];
            const generateResult = lessonPlanGenerator.generate(node.id);
            
            if (generateResult.success) {
                result.innerHTML = `<span class="success">âœ… æ•™æ¡ˆç”ŸæˆæˆåŠŸ</span>\nèŠ‚ç‚¹: ${generateResult.lessonPlan.nodeName}\nç« èŠ‚æ•°: ${generateResult.lessonPlan.sections.length}`;
            } else {
                result.innerHTML = `<span class="error">âŒ æ•™æ¡ˆç”Ÿæˆå¤±è´¥: ${generateResult.message}</span>`;
            }
        };
        
        window.testBatchGenerate = function() {
            const result = document.getElementById('lessonResult');
            result.style.display = 'block';
            
            const nodes = nodeDataManager.getAllNodes();
            if (nodes.length < 3) {
                result.innerHTML = '<span class="error">âŒ èŠ‚ç‚¹æ•°é‡ä¸è¶³</span>';
                return;
            }
            
            const nodeIds = nodes.slice(0, 3).map(n => n.id);
            const batchResult = lessonPlanGenerator.generateBatch(nodeIds);
            
            if (batchResult.success) {
                result.innerHTML = `<span class="success">âœ… æ‰¹é‡ç”ŸæˆæˆåŠŸ</span>\nç”Ÿæˆæ•°é‡: ${batchResult.count}`;
            } else {
                result.innerHTML = `<span class="error">âŒ æ‰¹é‡ç”Ÿæˆå¤±è´¥</span>`;
            }
        };
        
        window.testNodeEditor = function() {
            const result = document.getElementById('uiResult');
            result.style.display = 'block';
            result.innerHTML = 'æ‰“å¼€èŠ‚ç‚¹ç¼–è¾‘å™¨...';
            
            nodeEditor.openForCreate();
        };
        
        window.testLessonViewer = function() {
            const result = document.getElementById('uiResult');
            result.style.display = 'block';
            
            const nodes = nodeDataManager.getAllNodes();
            if (nodes.length === 0) {
                result.innerHTML = '<span class="error">âŒ æ²¡æœ‰å¯ç”¨çš„èŠ‚ç‚¹</span>';
                return;
            }
            
            const node = nodes[0];
            const generateResult = lessonPlanGenerator.generate(node.id);
            
            if (generateResult.success) {
                result.innerHTML = 'æ‰“å¼€æ•™æ¡ˆæŸ¥çœ‹å™¨...';
                lessonPlanViewer.show(generateResult.lessonPlan);
            } else {
                result.innerHTML = `<span class="error">âŒ æ— æ³•ç”Ÿæˆæ•™æ¡ˆ</span>`;
            }
        };
    </script>
</body>
</html>
