<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯¼å‡ºä¸åˆ†äº«åŠŸèƒ½æµ‹è¯• - Phase 2</title>
    
    <!-- å¤–éƒ¨åº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .header h1 {
            margin: 0 0 10px 0;
        }
        
        .section {
            background: white;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .section h2 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        .demo-area {
            background: #fafafa;
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
        }
        
        .demo-graph {
            width: 100%;
            height: 300px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: bold;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 15px 0;
        }
        
        button {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        button:hover {
            background: #764ba2;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .info-box {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #2196F3;
            margin: 15px 0;
        }
        
        .feature-list {
            list-style: none;
            padding: 0;
        }
        
        .feature-list li {
            padding: 10px;
            margin-bottom: 8px;
            background: #f5f5f5;
            border-radius: 5px;
            display: flex;
            align-items: center;
        }
        
        .feature-list li::before {
            content: 'âœ“';
            display: inline-block;
            width: 24px;
            height: 24px;
            background: #4CAF50;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 24px;
            margin-right: 10px;
            font-weight: bold;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-card .label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 8px;
        }
        
        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
        }
        
        .log-area {
            background: #1e1e1e;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 15px;
        }
        
        .log-entry {
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“¤ å¯¼å‡ºä¸åˆ†äº«åŠŸèƒ½æµ‹è¯•</h1>
            <p>Task 21: PDFå¯¼å‡º + Markdownå¯¼å‡º + æˆªå›¾å¯¼å‡º + åˆ†äº«é“¾æ¥</p>
        </div>

        <!-- åŠŸèƒ½æ¦‚è§ˆ -->
        <div class="section">
            <h2>ğŸ“Š åŠŸèƒ½æ¦‚è§ˆ</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="label">å¯¼å‡ºæ ¼å¼</div>
                    <div class="value">4</div>
                </div>
                <div class="stat-card">
                    <div class="label">åˆ†äº«åŠŸèƒ½</div>
                    <div class="value">2</div>
                </div>
                <div class="stat-card">
                    <div class="label">æ‰¹é‡å¯¼å‡º</div>
                    <div class="value">âœ“</div>
                </div>
                <div class="stat-card">
                    <div class="label">å®Œæˆåº¦</div>
                    <div class="value">100%</div>
                </div>
            </div>
        </div>

        <!-- PDFå¯¼å‡º -->
        <div class="section">
            <h2>ğŸ“„ PDFå¯¼å‡º</h2>
            <div class="info-box">
                <strong>åŠŸèƒ½è¯´æ˜:</strong> å¯¼å‡ºå­¦ä¹ è·¯å¾„ä¸ºPDFæ–‡ä»¶ï¼ŒåŒ…å«èŠ‚ç‚¹åˆ—è¡¨ã€éš¾åº¦ã€å­¦ä¹ æ—¶é•¿ç­‰ä¿¡æ¯
            </div>
            <div class="button-group">
                <button onclick="testPDFExport()">å¯¼å‡ºå­¦ä¹ è·¯å¾„PDF</button>
                <button onclick="testPDFWithDetails()">å¯¼å‡ºè¯¦ç»†PDF</button>
            </div>
        </div>

        <!-- Markdownå¯¼å‡º -->
        <div class="section">
            <h2>ğŸ“ Markdownå¯¼å‡º</h2>
            <div class="info-box">
                <strong>åŠŸèƒ½è¯´æ˜:</strong> å¯¼å‡ºèŠ‚ç‚¹å†…å®¹ä¸ºMarkdownæ–‡ä»¶ï¼ŒåŒ…å«æè¿°ã€å…¬å¼ã€ä»£ç ç­‰
            </div>
            <div class="button-group">
                <button onclick="testMarkdownExport()">å¯¼å‡ºèŠ‚ç‚¹Markdown</button>
                <button onclick="testMarkdownWithCode()">å¯¼å‡ºå¸¦ä»£ç Markdown</button>
            </div>
        </div>

        <!-- PNGæˆªå›¾ -->
        <div class="section">
            <h2>ğŸ–¼ï¸ PNGæˆªå›¾å¯¼å‡º</h2>
            <div class="info-box">
                <strong>åŠŸèƒ½è¯´æ˜:</strong> å¯¼å‡ºçŸ¥è¯†å›¾è°±æˆªå›¾ä¸ºPNGå›¾ç‰‡
            </div>
            <div class="demo-area">
                <div class="demo-graph" id="demo-graph">
                    çŸ¥è¯†å›¾è°±æ¼”ç¤ºåŒºåŸŸ
                </div>
            </div>
            <div class="button-group">
                <button onclick="testPNGExport()">å¯¼å‡ºå›¾è°±æˆªå›¾</button>
                <button onclick="testPNGHighRes()">å¯¼å‡ºé«˜æ¸…æˆªå›¾</button>
            </div>
        </div>

        <!-- åˆ†äº«é“¾æ¥ -->
        <div class="section">
            <h2>ğŸ”— åˆ†äº«é“¾æ¥</h2>
            <div class="info-box">
                <strong>åŠŸèƒ½è¯´æ˜:</strong> ç”Ÿæˆå¯åˆ†äº«çš„é“¾æ¥ï¼ŒåŒ…å«å›¾è°±è§†å›¾å’Œè¿‡æ»¤æ¡ä»¶
            </div>
            <div class="button-group">
                <button onclick="testGenerateLink()">ç”Ÿæˆåˆ†äº«é“¾æ¥</button>
                <button onclick="testParseLink()">è§£æåˆ†äº«é“¾æ¥</button>
                <button onclick="testCopyLink()">å¤åˆ¶åˆ°å‰ªè´´æ¿</button>
            </div>
            <div id="share-link-display" style="margin-top: 15px; display: none;">
                <input type="text" id="share-link-input" readonly style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
            </div>
        </div>

        <!-- JSONå¯¼å‡º/å¯¼å…¥ -->
        <div class="section">
            <h2>ğŸ’¾ å­¦ä¹ è¿›åº¦</h2>
            <div class="info-box">
                <strong>åŠŸèƒ½è¯´æ˜:</strong> å¯¼å‡ºå’Œå¯¼å…¥å­¦ä¹ è¿›åº¦æ•°æ®
            </div>
            <div class="button-group">
                <button onclick="testJSONExport()">å¯¼å‡ºè¿›åº¦JSON</button>
                <button onclick="testJSONImport()">å¯¼å…¥è¿›åº¦JSON</button>
            </div>
        </div>

        <!-- æ‰¹é‡å¯¼å‡º -->
        <div class="section">
            <h2>ğŸ“¦ æ‰¹é‡å¯¼å‡º</h2>
            <div class="info-box">
                <strong>åŠŸèƒ½è¯´æ˜:</strong> ä¸€é”®å¯¼å‡ºæ‰€æœ‰æ ¼å¼
            </div>
            <div class="button-group">
                <button onclick="testBatchExport()">æ‰¹é‡å¯¼å‡ºå…¨éƒ¨</button>
                <button onclick="openShareDialog()">æ‰“å¼€åˆ†äº«å¯¹è¯æ¡†</button>
            </div>
        </div>

        <!-- å·²å®ç°åŠŸèƒ½ -->
        <div class="section">
            <h2>âœ… å·²å®ç°åŠŸèƒ½</h2>
            <ul class="feature-list">
                <li>PDFå¯¼å‡ºï¼ˆå­¦ä¹ è·¯å¾„ï¼‰</li>
                <li>Markdownå¯¼å‡ºï¼ˆèŠ‚ç‚¹å†…å®¹ï¼‰</li>
                <li>PNGæˆªå›¾å¯¼å‡ºï¼ˆå›¾è°±ï¼‰</li>
                <li>åˆ†äº«é“¾æ¥ç”Ÿæˆ</li>
                <li>åˆ†äº«é“¾æ¥è§£æ</li>
                <li>JSONè¿›åº¦å¯¼å‡º/å¯¼å…¥</li>
                <li>æ‰¹é‡å¯¼å‡º</li>
                <li>å‰ªè´´æ¿å¤åˆ¶</li>
                <li>åˆ†äº«å¯¹è¯æ¡†UI</li>
            </ul>
        </div>

        <!-- æ—¥å¿— -->
        <div class="section">
            <h2>ğŸ“‹ æ“ä½œæ—¥å¿—</h2>
            <div class="log-area" id="log-area">
                <div class="log-entry">ç­‰å¾…æ“ä½œ...</div>
            </div>
        </div>
    </div>

    <script type="module">
        import { ExportManager } from './js/modules/ExportManager.js';
        import { ShareDialog } from './js/modules/ShareDialog.js';

        // åˆå§‹åŒ–
        const exportManager = new ExportManager();
        const shareDialog = new ShareDialog();

        // æ—¥å¿—å‡½æ•°
        function log(message) {
            const logArea = document.getElementById('log-area');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logArea.appendChild(entry);
            logArea.scrollTop = logArea.scrollHeight;
            console.log(message);
        }

        // æµ‹è¯•æ•°æ®
        const samplePath = [
            { id: 'node1', name: 'å‡½æ•°æé™', nameEn: 'Function Limits', difficulty: 2, estimatedStudyTime: 60, description: 'å­¦ä¹ å‡½æ•°æé™çš„åŸºæœ¬æ¦‚å¿µå’Œè®¡ç®—æ–¹æ³•' },
            { id: 'node2', name: 'å¯¼æ•°å®šä¹‰', nameEn: 'Derivative Definition', difficulty: 3, estimatedStudyTime: 90, description: 'ç†è§£å¯¼æ•°çš„å®šä¹‰å’Œå‡ ä½•æ„ä¹‰' },
            { id: 'node3', name: 'ç§¯åˆ†æ¦‚å¿µ', nameEn: 'Integral Concept', difficulty: 3, estimatedStudyTime: 75, description: 'æŒæ¡å®šç§¯åˆ†å’Œä¸å®šç§¯åˆ†çš„æ¦‚å¿µ' }
        ];

        const sampleNodes = [
            { 
                id: 'node1', 
                name: 'å‡½æ•°æé™', 
                nameEn: 'Function Limits',
                difficulty: 2,
                estimatedStudyTime: 60,
                domains: ['domain-1'],
                keywords: ['æé™', 'è¿ç»­'],
                description: 'å‡½æ•°æé™æ˜¯å¾®ç§¯åˆ†çš„åŸºç¡€æ¦‚å¿µï¼Œæè¿°å‡½æ•°åœ¨æŸç‚¹é™„è¿‘çš„å˜åŒ–è¶‹åŠ¿ã€‚',
                formula: '\\lim_{x \\to a} f(x) = L',
                prerequisites: [],
                applications: ['æ•°å€¼åˆ†æ', 'ç‰©ç†å»ºæ¨¡']
            }
        ];

        const sampleProgress = {
            completedNodes: ['node1', 'node2'],
            currentNode: 'node3',
            totalTime: 150,
            lastUpdate: new Date().toISOString()
        };

        // å…¨å±€å‡½æ•°
        window.testPDFExport = async function() {
            log('å¼€å§‹å¯¼å‡ºPDF...');
            try {
                const filename = await exportManager.exportLearningPathToPDF(samplePath);
                log(`âœ… PDFå¯¼å‡ºæˆåŠŸ: ${filename}`);
            } catch (error) {
                log(`âŒ PDFå¯¼å‡ºå¤±è´¥: ${error.message}`);
            }
        };

        window.testPDFWithDetails = async function() {
            log('å¼€å§‹å¯¼å‡ºè¯¦ç»†PDF...');
            try {
                const filename = await exportManager.exportLearningPathToPDF(samplePath, {
                    title: 'æˆ‘çš„å­¦ä¹ è·¯å¾„',
                    includeDetails: true,
                    includeEstimatedTime: true
                });
                log(`âœ… è¯¦ç»†PDFå¯¼å‡ºæˆåŠŸ: ${filename}`);
            } catch (error) {
                log(`âŒ è¯¦ç»†PDFå¯¼å‡ºå¤±è´¥: ${error.message}`);
            }
        };

        window.testMarkdownExport = function() {
            log('å¼€å§‹å¯¼å‡ºMarkdown...');
            try {
                const filename = exportManager.exportNodesToMarkdown(sampleNodes);
                log(`âœ… Markdownå¯¼å‡ºæˆåŠŸ: ${filename}`);
            } catch (error) {
                log(`âŒ Markdownå¯¼å‡ºå¤±è´¥: ${error.message}`);
            }
        };

        window.testMarkdownWithCode = function() {
            log('å¼€å§‹å¯¼å‡ºå¸¦ä»£ç Markdown...');
            try {
                const filename = exportManager.exportNodesToMarkdown(sampleNodes, {
                    includeCode: true,
                    includeFormulas: true
                });
                log(`âœ… å¸¦ä»£ç Markdownå¯¼å‡ºæˆåŠŸ: ${filename}`);
            } catch (error) {
                log(`âŒ å¸¦ä»£ç Markdownå¯¼å‡ºå¤±è´¥: ${error.message}`);
            }
        };

        window.testPNGExport = async function() {
            log('å¼€å§‹å¯¼å‡ºPNGæˆªå›¾...');
            try {
                const element = document.getElementById('demo-graph');
                const filename = await exportManager.exportGraphToPNG(element);
                log(`âœ… PNGæˆªå›¾å¯¼å‡ºæˆåŠŸ: ${filename}`);
            } catch (error) {
                log(`âŒ PNGæˆªå›¾å¯¼å‡ºå¤±è´¥: ${error.message}`);
            }
        };

        window.testPNGHighRes = async function() {
            log('å¼€å§‹å¯¼å‡ºé«˜æ¸…PNGæˆªå›¾...');
            try {
                const element = document.getElementById('demo-graph');
                const filename = await exportManager.exportGraphToPNG(element, {
                    scale: 3,
                    backgroundColor: '#ffffff'
                });
                log(`âœ… é«˜æ¸…PNGæˆªå›¾å¯¼å‡ºæˆåŠŸ: ${filename}`);
            } catch (error) {
                log(`âŒ é«˜æ¸…PNGæˆªå›¾å¯¼å‡ºå¤±è´¥: ${error.message}`);
            }
        };

        window.testGenerateLink = function() {
            log('å¼€å§‹ç”Ÿæˆåˆ†äº«é“¾æ¥...');
            try {
                const shareData = {
                    nodes: ['node1', 'node2'],
                    filters: { difficulty: [2, 3] },
                    view: { zoom: 1.5, center: [0, 0] }
                };
                const shareUrl = exportManager.generateShareLink(shareData);
                
                document.getElementById('share-link-display').style.display = 'block';
                document.getElementById('share-link-input').value = shareUrl;
                
                log(`âœ… åˆ†äº«é“¾æ¥ç”ŸæˆæˆåŠŸ`);
                log(`é“¾æ¥é•¿åº¦: ${shareUrl.length} å­—ç¬¦`);
            } catch (error) {
                log(`âŒ åˆ†äº«é“¾æ¥ç”Ÿæˆå¤±è´¥: ${error.message}`);
            }
        };

        window.testParseLink = function() {
            log('å¼€å§‹è§£æåˆ†äº«é“¾æ¥...');
            try {
                const input = document.getElementById('share-link-input');
                if (!input.value) {
                    log('âŒ è¯·å…ˆç”Ÿæˆåˆ†äº«é“¾æ¥');
                    return;
                }
                
                const data = exportManager.parseShareLink(input.value);
                if (data) {
                    log(`âœ… åˆ†äº«é“¾æ¥è§£ææˆåŠŸ`);
                    log(`è§£ææ•°æ®: ${JSON.stringify(data, null, 2)}`);
                } else {
                    log('âŒ åˆ†äº«é“¾æ¥è§£æå¤±è´¥');
                }
            } catch (error) {
                log(`âŒ åˆ†äº«é“¾æ¥è§£æå¤±è´¥: ${error.message}`);
            }
        };

        window.testCopyLink = async function() {
            log('å¼€å§‹å¤åˆ¶é“¾æ¥...');
            try {
                const input = document.getElementById('share-link-input');
                if (!input.value) {
                    log('âŒ è¯·å…ˆç”Ÿæˆåˆ†äº«é“¾æ¥');
                    return;
                }
                
                const success = await exportManager.copyShareLinkToClipboard(input.value);
                if (success) {
                    log('âœ… é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                } else {
                    log('âŒ å¤åˆ¶å¤±è´¥');
                }
            } catch (error) {
                log(`âŒ å¤åˆ¶å¤±è´¥: ${error.message}`);
            }
        };

        window.testJSONExport = function() {
            log('å¼€å§‹å¯¼å‡ºJSON...');
            try {
                const filename = exportManager.exportProgressToJSON(sampleProgress);
                log(`âœ… JSONå¯¼å‡ºæˆåŠŸ: ${filename}`);
            } catch (error) {
                log(`âŒ JSONå¯¼å‡ºå¤±è´¥: ${error.message}`);
            }
        };

        window.testJSONImport = function() {
            log('JSONå¯¼å…¥åŠŸèƒ½éœ€è¦æ–‡ä»¶é€‰æ‹©å™¨ï¼Œè¯·åœ¨å®é™…åº”ç”¨ä¸­æµ‹è¯•');
        };

        window.testBatchExport = async function() {
            log('å¼€å§‹æ‰¹é‡å¯¼å‡º...');
            try {
                const data = {
                    learningPath: samplePath,
                    nodes: sampleNodes,
                    graphElement: document.getElementById('demo-graph'),
                    progress: sampleProgress
                };
                
                const results = await exportManager.exportAll(data);
                log(`âœ… æ‰¹é‡å¯¼å‡ºå®Œæˆ`);
                log(`å¯¼å‡ºç»“æœ: ${JSON.stringify(results, null, 2)}`);
            } catch (error) {
                log(`âŒ æ‰¹é‡å¯¼å‡ºå¤±è´¥: ${error.message}`);
            }
        };

        window.openShareDialog = function() {
            log('æ‰“å¼€åˆ†äº«å¯¹è¯æ¡†...');
            const data = {
                learningPath: samplePath,
                nodes: sampleNodes,
                graphElement: document.getElementById('demo-graph'),
                progress: sampleProgress,
                selectedNodes: ['node1', 'node2'],
                filters: { difficulty: [2, 3] },
                view: { zoom: 1.5 }
            };
            
            shareDialog.show(data);
            log('âœ… åˆ†äº«å¯¹è¯æ¡†å·²æ‰“å¼€');
        };

        // æ£€æŸ¥åº“åŠ è½½çŠ¶æ€
        const libraries = exportManager.checkLibraries();
        log(`jsPDF: ${libraries.jsPDF ? 'âœ… å·²åŠ è½½' : 'âŒ æœªåŠ è½½'}`);
        log(`html2canvas: ${libraries.html2canvas ? 'âœ… å·²åŠ è½½' : 'âŒ æœªåŠ è½½'}`);
        log('ğŸ“¤ å¯¼å‡ºä¸åˆ†äº«åŠŸèƒ½æµ‹è¯•é¡µé¢å·²åŠ è½½');
    </script>
</body>
</html>
